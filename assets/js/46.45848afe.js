(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{212:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("div",{staticClass:"content"},[s("h2",{attrs:{id:"说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#说明","aria-hidden":"true"}},[t._v("#")]),t._v(" 说明")]),t._v(" "),s("p",[t._v("其他资料见 "),s("code",[t._v("android_workspace")]),t._v(" 下的直播目录下的相关项目")]),t._v(" "),s("h2",{attrs:{id:"基础知识"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基础知识","aria-hidden":"true"}},[t._v("#")]),t._v(" 基础知识")]),t._v(" "),s("p",[s("code",[t._v("https://blog.csdn.net/leixiaohua1020/article/details/18893769")])]),t._v(" "),s("h3",{attrs:{id:"视频编码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#视频编码","aria-hidden":"true"}},[t._v("#")]),t._v(" 视频编码")]),t._v(" "),s("p",[t._v("-- 视频编码的主要作用是将视频像素数据（RGB，YUV 等）压缩成为视频码流，从而降低视频的数据量。如果视频不经过压缩编码的话，体积通常是非常大的，一部电影可能就要上百 G 的空间。视频编码是视音频技术中最重要的技术之一。视频码流的数据量占了视音频总数据量的绝大部分。高效率的视频编码在同等的码率下，可以获得更高的视频质量。")]),t._v(" "),s("p",[t._v("当前使用最多的视频编码方案就是 H.264 也叫做 AVC\n实际中使用最多的就是 x264 了，性能强悍（超过了很多商业编码器），而且开源\nGoogle 推出的 VP8 属于和 H.264 同一时代的标准。总体而言，VP8 比 H.264 要稍微差一点")]),t._v(" "),s("h3",{attrs:{id:"音频编码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#音频编码","aria-hidden":"true"}},[t._v("#")]),t._v(" 音频编码")]),t._v(" "),s("p",[t._v("-- 音频编码的主要作用是将音频采样数据（PCM 等）压缩成为音频码流，从而降低音频的数据量。音频编码也是互联网视音频技术中一个重要的技术。但是一般情况下音频的数据量要远小于视频的数据量，因而即使使用稍微落后的音频编码标准，而导致音频数据量有所增加，也不会对视音频的总数据量产生太大的影响。高效率的音频编码在同等的码率下，可以获得更高的音质。")]),t._v(" "),s("p",[t._v("常见的就是 "),s("code",[t._v("aac, mp3, wma")]),t._v("\n音频编码技术近期绝大部分的改动都是在 MP3 的继任者——AAC 的基础上完成的。")]),t._v(" "),s("h3",{attrs:{id:"封装格式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#封装格式","aria-hidden":"true"}},[t._v("#")]),t._v(" 封装格式")]),t._v(" "),s("p",[t._v("-- 封装格式的主要作用是把视频码流和音频码流按照一定的格式存储在一个文件中")]),t._v(" "),s("p",[t._v("常见封装格式有: "),s("code",[t._v("avi, mp4, mov, flv")])]),t._v(" "),s("p",[t._v("但 avi 不支持流媒体,流媒体指的就是即可以“边下边播”")]),t._v(" "),s("p",[t._v("一般一种封装格式能支持多种视频编码格式")]),t._v(" "),s("p",[t._v("有些格式更“万能”一些，支持的视音频编码标准多一些，比如 "),s("code",[t._v("MKV")]),t._v("。而有些格式则支持的相对比较少，比如说 "),s("code",[t._v("RMVB")])]),t._v(" "),s("p",[t._v("比如 "),s("code",[t._v("MP4")]),t._v(" 封装格式就支持多种视频编码格式 "),s("code",[t._v("MPEG-2, MPEG-4, H.264, H.263等")])]),t._v(" "),s("p",[t._v("一般可以通过视频文件的属性来查看视音频技术 , 也就是上面提到的 3 个方面,")]),t._v(" "),s("p",[t._v("封装格式: 比如 "),s("code",[t._v("mov, mp4, flv")]),t._v(" 等\n"),s("code",[t._v("Video")]),t._v(" 编码: "),s("code",[t._v("AVC")]),t._v(" 也就是 "),s("code",[t._v("H264")]),t._v(" "),s("code",[t._v("Audio")]),t._v(" 编码: "),s("code",[t._v("AAC")])]),t._v(" "),s("h2",{attrs:{id:"直播相关视音频参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#直播相关视音频参数","aria-hidden":"true"}},[t._v("#")]),t._v(" 直播相关视音频参数")]),t._v(" "),s("p",[t._v("直播服务普遍采用了 RTMP 作为流媒体协议，FLV 作为封装格式，H.264 作为视频编码格式，AAC 作为音频编码格式。采用 RTMP 作为直播协议的好处在于其被 Flash 播放器支持。而 Flash 播放器如今已经安装在全球 99%的电脑上，并且与浏览器结合的很好。因此这种流媒体直播平台可以实现“无插件直播”，极大的简化了客户端的操作。封装格式，视频编码，音频编码方面，无一例外的使用了 "),s("code",[t._v("FLV + H.264 + AAC")]),t._v(" 的组合。FLV 是 RTMP 使用的封装格式，H.264 是当今实际应用中编码效率最高的视频编码标准，AAC 则是当今实际应用中编码效率最高的音频编码标准。视频播放器方面，都使用了 Flash 播放器。")]),t._v(" "),s("p",[s("strong",[t._v("注: 这只是 pc 端, 在移动端不可能用浏览器结合 flash 来做客户端, 一般都是用的 librtmp 来收流然后用 sdk 提供的播放器来播放")])]),t._v(" "),s("h2",{attrs:{id:"rtmp-协议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rtmp-协议","aria-hidden":"true"}},[t._v("#")]),t._v(" rtmp 协议")]),t._v(" "),s("p",[t._v("rtmp 的服务器端用 nginx 即可, 或者 srs 它本质上也还是用 nginx")]),t._v(" "),s("p",[t._v("直播数据流的推送和接收 ffmpeg 可以进行推流和收流, 还有转发流, 而且很多播放器都是在 ffmpeg 的基础上二次开发")]),t._v(" "),s("p",[t._v("但 ffmpeg 是控制台方式, 所以才有一些其他更方便的图形界面工具软件, 它最适合用来做教学直播, 或者教学视屏录播,")]),t._v(" "),s("p",[t._v("但不适合移动开发直播 app")]),t._v(" "),s("p",[t._v("因为 rtmp 形式的直播流, 无法使用 web 浏览器来播放, 它必须使用第三方 sdk 或者其他工具软件")]),t._v(" "),s("p",[t._v("而 hls 则可以使用 web 来接收直播流, 这样就对移动端的开发降低难度同时也更灵活, 可以使用 web 技术来开发直播客户端")]),t._v(" "),s("h2",{attrs:{id:"rtmp-媒体服务器的搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rtmp-媒体服务器的搭建","aria-hidden":"true"}},[t._v("#")]),t._v(" rtmp 媒体服务器的搭建")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("nginx")]),t._v(" 可以用来做 "),s("code",[t._v("rtmp")]),t._v(" , 而 "),s("code",[t._v("srs")]),t._v(" 里面实际上也集成的是 "),s("code",[t._v("nginx")])]),t._v(" "),s("p",[s("code",[t._v("srs")]),t._v(" 服务器")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("git clone https://github.com/ossrs/srs.git\ncd srs/trunk\n./configure --osx\n注意： Centos6.x/Ubuntu12 32/64bits用户仅需要执行./configure。\nmake\n./etc/init.d/srs start\n")])])]),s("p",[s("code",[t._v("https://my.oschina.net/fengjihu/blog/413798")])]),t._v(" "),s("p",[s("code",[t._v("srs")]),t._v(" 配置")]),t._v(" "),s("p",[s("code",[t._v("https://my.oschina.net/higkoo/blog/710854")])]),t._v(" "),s("p",[t._v("而且 "),s("code",[t._v("srs")]),t._v(" 还能设置虚拟主机类似的地址")]),t._v(" "),s("p",[t._v("访问配置过 "),s("code",[t._v("vhost")]),t._v(" 的流："),s("code",[t._v("rtmp://srs_ip:1935/application?vhost=vhost_name/stream_name")])]),t._v(" "),s("p",[t._v("srs_ip:srs 的 ip 地址")]),t._v(" "),s("p",[t._v("application：应用名，一般习惯是 live")]),t._v(" "),s("p",[t._v("stream_name：流名称")]),t._v(" "),s("h3",{attrs:{id:"使用-nginx-作为-rtmp-服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-nginx-作为-rtmp-服务器","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 nginx 作为 rtmp 服务器")]),t._v(" "),s("p",[s("code",[t._v("https://www.jianshu.com/p/8ea016b2720e")])]),t._v(" "),s("h2",{attrs:{id:"使用-obs-推流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-obs-推流","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 OBS 推流")]),t._v(" "),s("p",[s("code",[t._v("https://obsproject.com/")])]),t._v(" "),s("p",[s("code",[t._v("obs")]),t._v(" 的使用 "),s("code",[t._v("https://www.youtube.com/watch?v=UqBn4FfKQn0")])]),t._v(" "),s("p",[t._v("注意:")]),t._v(" "),s("p",[t._v("测试的时候几次都推流失败\n从 "),s("code",[t._v("srs")]),t._v(" 服务端的日志中错误 才发现 "),s("code",[t._v("obs")]),t._v(" 推流的设置里面流设置中 服务器指的是 服务器地址和 "),s("code",[t._v("app")]),t._v(" 地址, 而流密钥是 "),s("code",[t._v("stream")]),t._v(" 参数")]),t._v(" "),s("p",[t._v("推流收流的完整地址是"),s("code",[t._v("rtmp://服务器地址:端口/app 名称/流名称")]),t._v(" 而这个地址是 obs 在推流的时候设定的 ,")]),t._v(" "),s("p",[s("code",[t._v("obs")]),t._v(" 软件里面却把 "),s("code",[t._v("stream")]),t._v(" 参数称为流密钥, 所以需要注意它是流地址的一部分,否则收流的时候错误找不到原因")]),t._v(" "),s("p",[t._v("// srs 服务端的日志中错误")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("04")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.806")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("trace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17925")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("107")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" connected stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tcUrl"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rtmp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ufo2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rt"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pageUrl"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" swfUrl"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rtmp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("ufo2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rt"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" schema"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rtmp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vhost"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("__defaultVhost__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" port"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1935")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stream"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" param"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("04")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.806")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17925")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("107")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RTMP")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Empty stream name not allowed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ret"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2050")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Resource temporarily unavailable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("04")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("03")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.806")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17925")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("107")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" stream service cycle failed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" ret"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2050")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Resource temporarily unavailable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),s("p",[t._v("实际测试发现在自己的 "),s("code",[t._v("mac")]),t._v(" 上安装失败, 提示是 mac 版本过高不支持, 只能在 "),s("code",[t._v("ufo2.vps.rt")]),t._v(" 上测试了下 ,")]),t._v(" "),s("p",[t._v('"rtmp://154.223.147.137/myapp/hello";')]),t._v(" "),s("p",[t._v("播放")]),t._v(" "),s("p",[s("code",[t._v("ffplay 'rtmp://154.223.147.137/myapp/hello live=1'")])]),t._v(" "),s("h2",{attrs:{id:"使用-vlc-拉流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-vlc-拉流","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 VLC 拉流")]),t._v(" "),s("p",[s("code",[t._v("VLC media player")])]),t._v(" "),s("p",[s("code",[t._v("http://www.videolan.org/vlc/")])]),t._v(" "),s("h2",{attrs:{id:"播放器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#播放器","aria-hidden":"true"}},[t._v("#")]),t._v(" 播放器")]),t._v(" "),s("p",[s("code",[t._v("https://developer.qiniu.com/pili/kb/3848/web-player-is-recommended")])]),t._v(" "),s("p",[t._v("注意：网页端如果播放 "),s("code",[t._v("rtmp")]),t._v(" 或者 "),s("code",[t._v("flv")]),t._v(" 形式 的直播流，需要 "),s("code",[t._v("flash")]),t._v(" 插件支持，由于手机 "),s("code",[t._v("web")]),t._v(" 端基本无法调用 "),s("code",[t._v("flash")]),t._v(" 插件，\n所以手机 "),s("code",[t._v("web")]),t._v(" 端一般使用 hls（即 m3u8）的形式进行直播。")]),t._v(" "),s("h2",{attrs:{id:"使用腾讯云直播测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用腾讯云直播测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用腾讯云直播测试")]),t._v(" "),s("p",[s("code",[t._v("https://www.jianshu.com/p/bf4066028882")])]),t._v(" "),s("h2",{attrs:{id:"ffmpeg"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg","aria-hidden":"true"}},[t._v("#")]),t._v(" ffmpeg")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("ffmpeg")]),t._v(" 转播直播源")]),t._v(" "),s("p",[s("code",[t._v("https://www.youtube.com/watch?v=sT78MRY9YRY")])]),t._v(" "),s("h2",{attrs:{id:"niginx-和-ffmpeg-来推收流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#niginx-和-ffmpeg-来推收流","aria-hidden":"true"}},[t._v("#")]),t._v(" niginx 和 ffmpeg 来推收流")]),t._v(" "),s("p",[t._v("参考 百度网盘 直播相关视频")]),t._v(" "),s("p",[t._v("安装\nhttps://blog.csdn.net/zcvbnh/article/details/79495285\nhttps://www.jianshu.com/p/5bd4c8791228")]),t._v(" "),s("p",[s("code",[t._v("brew tap denji/nginx")]),t._v(" "),s("code",[t._v("brew install nginx-full --with-rtmp-module")])]),t._v(" "),s("p",[t._v("查看安装路径等信息")]),t._v(" "),s("p",[t._v("brew info nginx-full")]),t._v(" "),s("p",[t._v("nginx 日志路径 "),s("code",[t._v("/usr/local/var/log/nginx/error.log")])]),t._v(" "),s("p",[s("code",[t._v("nginx")]),t._v(" // 启动")]),t._v(" "),s("p",[s("code",[t._v("brew install ffmpeg")])]),t._v(" "),s("p",[t._v("配置")]),t._v(" "),s("p",[s("code",[t._v("/usr/local/etc/nginx/nginx.conf")])]),t._v(" "),s("p",[t._v("可配置的服务有, rtmp, hls, http/flv")]),t._v(" "),s("p",[t._v("http/flv 和 rtmp 相似")]),t._v(" "),s("p",[t._v("// open nginx.conf -a code , 用 code 打开 nginx.conf")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("rtmp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1935")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chunk_size "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        # rtmp conig\n        application rtmplive "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            live on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            max_connections "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        # hls config\n\n        application hls "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            live on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            hls on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            hls_path "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hls"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            hls_fragment "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("修改 nginx.conf 中的 server 块, 添加 /hls 路径")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("\nlocation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hls "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        application"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("vnd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apple"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mpegurl m3u8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        video"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("mp2t ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    root "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    add_header Cache"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Control no"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("p",[t._v("// 注意, 配置 nginx http 访问的 root 地址只需要 "),s("code",[t._v("/usr/local/var/www")]),t._v(" 即可, 而不是 "),s("code",[t._v("/usr/local/var/www/hls")])]),t._v(" "),s("p",[t._v("推流的时候实际是推送到 /usr/local/var/www/hls , hls 是 rtmp 中的 server 部分配置的应用名")]),t._v(" "),s("p",[t._v("修改完配置后重启 nginx -s reload")]),t._v(" "),s("h2",{attrs:{id:"hls"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hls","aria-hidden":"true"}},[t._v("#")]),t._v(" hls")]),t._v(" "),s("p",[t._v("rtmp 配置段中配置了 "),s("code",[t._v("application hls")])]),t._v(" "),s("p",[t._v("hls_path 是存储视频分片的目录 /usr/local/var/www/hls, 后面我们在推流的时候就实际上是推送到了这个目录")]),t._v(" "),s("p",[t._v("nginx 中又配置了"),s("code",[t._v("application hls")]),t._v(" 我们又在 "),s("code",[t._v("http")]),t._v(" 中配置了 "),s("code",[t._v("/hls")]),t._v(" 访问路径实际访问的就是 "),s("code",[t._v("hls_path")])]),t._v(" "),s("p",[t._v("于是, 直播的分片视频就能被 "),s("code",[t._v("http://localhost/hls/$streamName.m3u8")]),t._v(" 这个地址来访问了")]),t._v(" "),s("p",[t._v("比如, 推送:")]),t._v(" "),s("p",[s("code",[t._v("ffmpeg -re -i test.mp4 -vcodec libx264 -acodec aac -f flv rtmp://localhost:1935/hls/stream")])]),t._v(" "),s("p",[t._v("收流 用 safari 打开 http://localhost:8080/hls/stream.m3u8 即可访问上面的推流")]),t._v(" "),s("p",[t._v("经测试发现 hls 的延时有点过分")]),t._v(" "),s("p",[t._v("https://www.zhihu.com/question/43209848")]),t._v(" "),s("h2",{attrs:{id:"ffmpeg-推流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg-推流","aria-hidden":"true"}},[t._v("#")]),t._v(" ffmpeg 推流")]),t._v(" "),s("p",[t._v("下载一个 "),s("code",[t._v("mp4")]),t._v(" 的视频放在工作目录")]),t._v(" "),s("p",[s("code",[t._v("cd ~/h5live-demo")])]),t._v(" "),s("p",[s("code",[t._v("ffmpeg -re -i test.mp4 -vcodec libx264 -acodec aac -f flv rtmp://localhost:1935/rtmplive/rtmp")])]),t._v(" "),s("p",[s("code",[t._v("ffmpeg -re -i 13.mp4 -vcodec libx264 -acodec aac -f flv rtmp://localhost:1935/rtmplive/rtmp")])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("-i 输入, 这里是直接把 mp4 作为输入源,实际中就是根据需要其他的数据源\n-v 视频编码\n-a 音频编码\nrtmp 推送地址, rtmplive 是 nginx 中配置的应用名称, 最后的 rtmp 路径是频道名")])])]),t._v(" "),s("h2",{attrs:{id:"前端-react-结合-node-进行直播"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前端-react-结合-node-进行直播","aria-hidden":"true"}},[t._v("#")]),t._v(" 前端 react 结合 node 进行直播")]),t._v(" "),s("p",[s("code",[t._v("https://github.com/tabvn/video-streaming-service")]),t._v(" "),s("code",[t._v("https://www.youtube.com/watch?v=OS6ZAlCZvGs&list=PLFaW_8zE4amPRvRNZwyc_-XGPLTyoILhd")])]),t._v(" "),s("h2",{attrs:{id:"android-屏幕直播"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#android-屏幕直播","aria-hidden":"true"}},[t._v("#")]),t._v(" android 屏幕直播")]),t._v(" "),s("p",[t._v("流程和原理, 从老外项目 "),s("code",[t._v("readme")]),t._v(" 抄下来, 其实也就是"),s("code",[t._v("音频编码流")]),t._v(", 和"),s("code",[t._v("视频编码流")]),t._v(", 然后封装为 "),s("code",[t._v("flv")]),t._v(" 进行以"),s("code",[t._v("rtmp")]),t._v("协议推流")]),t._v(" "),s("div",{staticClass:"language-s extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("\nH264 Hardware Encoders are used to encode the camera preview.\nIt runs on Android 4.3 and above. Using hardware encoders make the mobile app very small and efficient.\nRTMP protocol is used to send the live stream to Media Server.\nWe have used librtmp library to handle this issue.\nFLV format is used to send live stream to Media Server via RTMP protocol.\nThis technical details are enough at this stage.\n\n")])])]),s("p",[s("code",[t._v("https://github.com/ant-media/LiveVideoBroadcaster")])]),t._v(" "),s("h2",{attrs:{id:"拉流播放"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拉流播放","aria-hidden":"true"}},[t._v("#")]),t._v(" 拉流播放")]),t._v(" "),s("p",[s("code",[t._v("https://blog.csdn.net/Mr_Sk/article/details/71083366")])]),t._v(" "),s("p",[s("code",[t._v("http://www.52im.net/thread-965-1-1.html")])]),t._v(" "),s("p",[s("code",[t._v("https://blog.csdn.net/qq_28268507/article/details/53098980")])]),t._v(" "),s("h2",{attrs:{id:"librtmp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#librtmp","aria-hidden":"true"}},[t._v("#")]),t._v(" librtmp")]),t._v(" "),s("p",[s("code",[t._v("c")]),t._v(" 语言实现的 "),s("code",[t._v("rtmp")]),t._v(" 协议")]),t._v(" "),s("p",[s("code",[t._v("https://www.jianshu.com/p/3ee9e5e4d630")])]),t._v(" "),s("div",{staticClass:"language-s extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ERROR: Unable to find toolchain: /Users/hendry/Library/Android/sdk/ndk-bundle/toolchains/mipsel-linux-android-4.9/prebuilt\n")])])]),s("p",[s("code",[t._v("librtmp")]),t._v(" 的 "),s("code",[t._v("android")]),t._v(" 例子不用跑, 太老了, 花了大量时间跑不起来")]),t._v(" "),s("p",[t._v("不如看其他项目中直接应用 "),s("code",[t._v("https://www.cnblogs.com/raomengyang/p/6544908.html")])]),t._v(" "),s("h2",{attrs:{id:"金山-sdk"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#金山-sdk","aria-hidden":"true"}},[t._v("#")]),t._v(" 金山 sdk")]),t._v(" "),s("p",[s("code",[t._v("github")]),t._v(" 下载项目下来可以顺利跑起来, 依然有延时")]),t._v(" "),s("h2",{attrs:{id:"录屏-结合-mediacodec-编码使用-librtmp-推流到-rtmp-服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#录屏-结合-mediacodec-编码使用-librtmp-推流到-rtmp-服务器","aria-hidden":"true"}},[t._v("#")]),t._v(" 录屏 结合 MediaCodec 编码使用 librtmp 推流到 rtmp 服务器")]),t._v(" "),s("p",[s("code",[t._v("https://www.cnblogs.com/raomengyang/p/6544908.html")])]),t._v(" "),s("p",[s("strong",[t._v("录屏推流的流程：")])]),t._v(" "),s("ol",[s("li",[t._v("客户端原始帧编码为 H264 裸流（MediaCodec，Android API） —>")]),t._v(" "),s("li",[t._v("再封装为 FLV 格式的视频流（Java） —>")]),t._v(" "),s("li",[t._v("按照 rtmp 流媒体协议通过 librtmp（JNI + C）推流到 RTMP 流媒体服务器 —>")]),t._v(" "),s("li",[t._v("客户端播放器解码观看")])]),t._v(" "),s("p",[t._v("注意：")]),t._v(" "),s("p",[t._v("Demo 省略了 librestreaming 中的 OpenGL 处理帧率的过程，也就意味着我们使用的是 MediaCodec 直接编码后的数据，并没有 OpenGL 绘制 VirtualDisplay 映射给 MediaCodec.createInputSurface 中 Surface 的这个过程，目的是将流程简单化。OpenGL 方面的使用之后我也会介绍说明。")]),t._v(" "),s("p",[t._v("录屏数据流的获取")]),t._v(" "),s("p",[t._v("自己测试的录屏项目录屏主要用的是 MediaRecorder 这个类, 它很方便的可以用来录屏保存为文件,")]),t._v(" "),s("p",[t._v("而我们推流的话, 是需要得到 H264 裸流, 而 MediaRecorder 使用中并没有直接接触到裸流")]),t._v(" "),s("p",[t._v("在更早版本 andriod 中, 如果不用 MediaRecorder 的话, 录屏保存文件用的是 MediaMuxer 这个类, 其他步骤是一致的")]),t._v(" "),s("p",[t._v("录屏的过程中核心类是 MediaProjection , 其中的 createVirtualDisplay 方法,")]),t._v(" "),s("p",[t._v("Creates a VirtualDisplay to capture the contents of the screen.")]),t._v(" "),s("p",[t._v("而这个方法中的, 需要传递 surface 参数, surface 是数据消费者 , 也就是说录屏的数据输出传递给该 surface")]),t._v(" "),s("p",[t._v("The surface to which the content of the virtual display should be rendered")]),t._v(" "),s("p",[t._v("所以 createVirtualDisplay 传参 mediaRecorder.getSurface() 即可把录屏流数据传递给 mediaRecorder 对象中的 surface")]),t._v(" "),s("p",[t._v("// MediaRecorder 录屏流程")]),t._v(" "),s("p",[t._v("先设置一下 mediaRecorder 的参数 --\x3e 再调用 createVirtualDisplay --\x3e mediaRecorder.start();")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setOutputFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("videoUri"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAudioSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaRecorder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AudioSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MIC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setVideoSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaRecorder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VideoSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SURFACE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setOutputFormat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaRecorder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OutputFormat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("THREE_GPP"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setVideoSize")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DISPLAY_WIDTH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DISPLAY_HEIGHT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setVideoEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaRecorder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VideoEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("H264"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAudioEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaRecorder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AudioEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AMR_NB"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setVideoEncodingBitRate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("512")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setVideoFrameRate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" rotation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getWindowManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDefaultDisplay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRotation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" orientation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ORIENTATIONS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rotation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setOrientationHint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("orientation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepare")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            mediaProjection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createVirtualDisplay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MainActivity"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DISPLAY_WIDTH"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DISPLAY_HEIGHT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mScreenDensity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DisplayManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSurface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            mediaRecorder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("如果不用 "),s("code",[t._v("MediaRecorder")]),t._v(" 的方式, 那么通过 "),s("code",[t._v("MediaProjection")]),t._v(" 的 "),s("code",[t._v("createVirtualDisplay")]),t._v(" 方法传递不同的 "),s("code",[t._v("surface")]),t._v(" 参数就能获取到流数据")]),t._v(" "),s("p",[t._v("核心用到的类还有 "),s("code",[t._v("VideoEncoder")]),t._v(" ,")]),t._v(" "),s("p",[t._v("首先通过配置初始化 "),s("code",[t._v("mVideoEncoder")]),t._v(" 对象 , 比如视频编码格式 "),s("code",[t._v("H264")]),t._v(" 就是初始化该对象可以传递的参数")]),t._v(" "),s("p",[t._v("传递 "),s("code",[t._v("surface")]),t._v(" 给录屏方法获取输入流, "),s("code",[t._v("mMediaProjection.createVirtualDisplay(...mVideoEncoder.getInputSurface())")])]),t._v(" "),s("p",[t._v("获取输出流 "),s("code",[t._v("mVideoEncoder.getOutputBuffer(index);")]),t._v(" 这里得到的就是编码后的视频缓存, 也就是 "),s("code",[t._v("H264")]),t._v(" 裸流")]),t._v(" "),s("p",[t._v("如果只是录屏保存文件的话, 那么调用 "),s("code",[t._v("MediaMuxer")]),t._v(" 这个类, "),s("code",[t._v("https://www.jianshu.com/p/aeadf260258a")])]),t._v(" "),s("p",[t._v("可见不使用 "),s("code",[t._v("MediaRecorder")]),t._v(" 录屏的话, 流的编码和输入输出, 需要的是 "),s("code",[t._v("mVideoEncoder")])]),t._v(" "),s("p",[t._v("如果要推流就必须要 "),s("code",[t._v("VideoEncoder")]),t._v(" 来获取 "),s("code",[t._v("H264")]),t._v(" 裸流")]),t._v(" "),s("p",[s("strong",[t._v("流程")])]),t._v(" "),s("ol",[s("li",[t._v("初始化 "),s("code",[t._v("VideoEncoder")]),t._v(", 设置编码格式 --\x3e")]),t._v(" "),s("li",[t._v("调用 "),s("code",[t._v("mMediaProjection.createVirtualDisplay")]),t._v(" 设置流输入到 "),s("code",[t._v("mVideoEncoder")]),t._v(" 的 "),s("code",[t._v("surface")])]),t._v(" "),s("li",[s("code",[t._v("mVideoEncoder")]),t._v(" 获取裸流 "),s("code",[t._v("mVideoEncoder.getOutputBuffer(index)")])]),t._v(" "),s("li",[s("code",[t._v("MediaMuxer")]),t._v(" 将裸流写入到文件 "),s("code",[t._v("mMuxer.writeSampleData(track, encodedData, buffer);")])])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化VideoEncoder类的对象, 编码通过video_config设置")]),t._v("\nmVideoEncoder "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VideoEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("video_config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// createVirtualDisplay设置流输入为mVideoEncoder的surface")]),t._v("\nmVirtualDisplay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mMediaProjection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createVirtualDisplay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TAG "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-display"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                mWidth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mHeight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mDpi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DisplayManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("VIRTUAL_DISPLAY_FLAG_PUBLIC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                mVideoEncoder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInputSurface")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mVideoEncoder将视屏流输出 mVideoEncoder.getOutputBuffer(index)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("muxVideo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaCodec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BufferInfo")]),t._v(" buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ByteBuffer")]),t._v(" encodedData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mVideoEncoder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getOutputBuffer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeSampleData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mVideoTrackIndex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encodedData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    mVideoEncoder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("releaseOutputBuffer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 循环获取视频流")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("info "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mPendingVideoEncoderBufferInfos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("poll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" index "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mPendingVideoEncoderBufferIndices"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("poll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("muxVideo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// MediaMuxer 保存到文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeSampleData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" track"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MediaCodec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BufferInfo")]),t._v(" buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ByteBuffer")]),t._v(" encodedData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n        mMuxer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeSampleData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("track"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encodedData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("h2",{attrs:{id:"紫鲸云-easyscreenlive-这个-sdk-看起来不错"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#紫鲸云-easyscreenlive-这个-sdk-看起来不错","aria-hidden":"true"}},[t._v("#")]),t._v(" 紫鲸云 EasyScreenLive 这个 sdk 看起来不错")]),t._v(" "),s("p",[s("code",[t._v("http://www.pvale.com/")])]),t._v(" "),s("h2",{attrs:{id:"直播和-rtmp-的重要基础知识参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#直播和-rtmp-的重要基础知识参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 直播和 rtmp 的重要基础知识参考资料")]),t._v(" "),s("p",[s("code",[t._v("https://blog.csdn.net/leixiaohua1020/article/details/15814587")])]),t._v(" "),s("p",[s("code",[t._v("rtmp")]),t._v(" 通信流程\n"),s("code",[t._v("https://blog.csdn.net/leixiaohua1020/article/details/42104893")]),t._v(" "),s("code",[t._v("https://blog.csdn.net/occupy8/article/details/42812365")]),t._v(" "),s("code",[t._v("http://chenzhenianqing.com/articles/1009.html#more-1009")]),t._v(" "),s("code",[t._v("RTMP_SetBufferMS")]),t._v("//告诉服务器帮我缓存多久\n"),s("code",[t._v("https://github.com/yrom/ScreenRecorder")])]),t._v(" "),s("h2",{attrs:{id:"android-直播相关参考资源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#android-直播相关参考资源","aria-hidden":"true"}},[t._v("#")]),t._v(" android 直播相关参考资源")]),t._v(" "),s("p",[s("code",[t._v("https://blog.csdn.net/lmj623565791/article/details/77937483")]),t._v("(轻松入门 Android 直播相关技术 从 0 搭建直播系统 -- 鸿洋博客)\n"),s("code",[t._v("https://www.imooc.com/video/16103")]),t._v(" (Android 节目直播案例开发 原生开发 rtmp)")]),t._v(" "),s("h2",{attrs:{id:"其他资源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他资源","aria-hidden":"true"}},[t._v("#")]),t._v(" 其他资源")]),t._v(" "),s("p",[t._v("ios 推流 "),s("code",[t._v("http://www.helloted.com/%E7%9B%B4%E6%92%AD/2018/05/03/librtmp/")])])])}],!1,null,null,null);a.default=e.exports}}]);