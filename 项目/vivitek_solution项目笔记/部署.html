<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>部署 | 工作笔记</title>
    <meta name="description" content="Hendry的博客">
    <link rel="icon" href="/img/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.eecf6a6a.css" as="style"><link rel="preload" href="/assets/js/app.f8bee57c.js" as="script"><link rel="preload" href="/assets/js/56.bc578093.js" as="script"><link rel="prefetch" href="/assets/js/10.837bbfd0.js"><link rel="prefetch" href="/assets/js/11.bbd08110.js"><link rel="prefetch" href="/assets/js/12.eb514b46.js"><link rel="prefetch" href="/assets/js/13.e2503408.js"><link rel="prefetch" href="/assets/js/14.d97c0ac2.js"><link rel="prefetch" href="/assets/js/15.baf7986f.js"><link rel="prefetch" href="/assets/js/16.2b12bf6f.js"><link rel="prefetch" href="/assets/js/17.f7e545ac.js"><link rel="prefetch" href="/assets/js/18.70d9230d.js"><link rel="prefetch" href="/assets/js/19.0a61e7ba.js"><link rel="prefetch" href="/assets/js/2.d139c70a.js"><link rel="prefetch" href="/assets/js/20.87141f48.js"><link rel="prefetch" href="/assets/js/21.536e6d3b.js"><link rel="prefetch" href="/assets/js/22.fa3e648a.js"><link rel="prefetch" href="/assets/js/23.f6c367b9.js"><link rel="prefetch" href="/assets/js/24.a8f770f5.js"><link rel="prefetch" href="/assets/js/25.3bb8bbfc.js"><link rel="prefetch" href="/assets/js/26.1c16cfb8.js"><link rel="prefetch" href="/assets/js/27.075df559.js"><link rel="prefetch" href="/assets/js/28.90c1e366.js"><link rel="prefetch" href="/assets/js/29.3145e78e.js"><link rel="prefetch" href="/assets/js/3.de89ea98.js"><link rel="prefetch" href="/assets/js/30.9832e5bd.js"><link rel="prefetch" href="/assets/js/31.2f9a7c5b.js"><link rel="prefetch" href="/assets/js/32.df9181b5.js"><link rel="prefetch" href="/assets/js/33.ec53f96d.js"><link rel="prefetch" href="/assets/js/34.398a7128.js"><link rel="prefetch" href="/assets/js/35.bb1c5a48.js"><link rel="prefetch" href="/assets/js/36.935a5449.js"><link rel="prefetch" href="/assets/js/37.459fef35.js"><link rel="prefetch" href="/assets/js/38.f51023c1.js"><link rel="prefetch" href="/assets/js/39.ed9f7023.js"><link rel="prefetch" href="/assets/js/4.a889cc83.js"><link rel="prefetch" href="/assets/js/40.7959ecc5.js"><link rel="prefetch" href="/assets/js/41.2f350c5b.js"><link rel="prefetch" href="/assets/js/42.3a09f5a5.js"><link rel="prefetch" href="/assets/js/43.b22e3395.js"><link rel="prefetch" href="/assets/js/44.ea91f873.js"><link rel="prefetch" href="/assets/js/45.29363c9f.js"><link rel="prefetch" href="/assets/js/46.45848afe.js"><link rel="prefetch" href="/assets/js/47.309f8db5.js"><link rel="prefetch" href="/assets/js/48.4da217ee.js"><link rel="prefetch" href="/assets/js/49.713e67fd.js"><link rel="prefetch" href="/assets/js/5.7183a5fb.js"><link rel="prefetch" href="/assets/js/50.d90574c6.js"><link rel="prefetch" href="/assets/js/51.5190cc6c.js"><link rel="prefetch" href="/assets/js/52.25c37497.js"><link rel="prefetch" href="/assets/js/53.3fea90a3.js"><link rel="prefetch" href="/assets/js/54.d23ad054.js"><link rel="prefetch" href="/assets/js/55.d8ba3a31.js"><link rel="prefetch" href="/assets/js/57.cb8c611e.js"><link rel="prefetch" href="/assets/js/58.4a6efece.js"><link rel="prefetch" href="/assets/js/59.397f12f2.js"><link rel="prefetch" href="/assets/js/6.6621a9ba.js"><link rel="prefetch" href="/assets/js/60.a209bb60.js"><link rel="prefetch" href="/assets/js/61.0a1b1f3b.js"><link rel="prefetch" href="/assets/js/62.a79409e9.js"><link rel="prefetch" href="/assets/js/63.f99fda12.js"><link rel="prefetch" href="/assets/js/64.59a96a9c.js"><link rel="prefetch" href="/assets/js/65.ab4be186.js"><link rel="prefetch" href="/assets/js/66.df4455cd.js"><link rel="prefetch" href="/assets/js/7.a024304b.js"><link rel="prefetch" href="/assets/js/8.be16c405.js"><link rel="prefetch" href="/assets/js/9.37e77487.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eecf6a6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">工作笔记</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/menu.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/Android/" class="nav-link">Android</a></div><div class="nav-item"><a href="/直播/" class="nav-link">直播</a></div><div class="nav-item"><a href="/前端/" class="nav-link">前端</a></div><div class="nav-item"><a href="/公众号/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/项目/" class="nav-link">项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">冒泡</a></li><li class="dropdown-subitem"><a href="/language/japanese.html" class="nav-link">快速</a></li></ul></li><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">工厂</a></li><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">单例</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/menu.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/Android/" class="nav-link">Android</a></div><div class="nav-item"><a href="/直播/" class="nav-link">直播</a></div><div class="nav-item"><a href="/前端/" class="nav-link">前端</a></div><div class="nav-item"><a href="/公众号/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/项目/" class="nav-link">项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">冒泡</a></li><li class="dropdown-subitem"><a href="/language/japanese.html" class="nav-link">快速</a></li></ul></li><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">工厂</a></li><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">单例</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>部署</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#api-server-的部署" class="sidebar-link">API SERVER 的部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#上传代码到git仓库-配置公钥无密码拉取代码" class="sidebar-link">上传代码到git仓库, 配置公钥无密码拉取代码</a></li></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#使用pm2-部署项目" class="sidebar-link">使用PM2 部署项目</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#pm2设置node-env环境变量-port-端口等" class="sidebar-link">pm2设置NODE_ENV环境变量 PORT 端口等</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#自动部署" class="sidebar-link">自动部署</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#mongodb-数据的导出导入" class="sidebar-link">mongodb 数据的导出导入</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#mongodb-账号密码登陆" class="sidebar-link">mongodb 账号密码登陆</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#centos-7-开启mongodb-auth参数" class="sidebar-link">centos 7 开启mongodb auth参数</a></li></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#mongoose-区分发环境和线上环境" class="sidebar-link">mongoose 区分发环境和线上环境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#app端配置线上的api地址" class="sidebar-link">APP端配置线上的API地址</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#安装node" class="sidebar-link">安装node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#解压" class="sidebar-link">解压</a></li><li class="sidebar-sub-header"><a href="/%E9%A1%B9%E7%9B%AE/vivitek_solution%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E9%83%A8%E7%BD%B2.html#node添加到path" class="sidebar-link">node添加到path</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="部署"><a href="#部署" aria-hidden="true" class="header-anchor">#</a> 部署</h1> <p>线上测试</p> <h2 id="api-server-的部署"><a href="#api-server-的部署" aria-hidden="true" class="header-anchor">#</a> API SERVER 的部署</h2> <p>代码本地更新后每次上传到git仓库,</p> <p>实际的服务器从git下载更新代码, 并自动重启服务</p> <p><code>http://git.mydoc.io/?t=154712</code></p> <h3 id="上传代码到git仓库-配置公钥无密码拉取代码"><a href="#上传代码到git仓库-配置公钥无密码拉取代码" aria-hidden="true" class="header-anchor">#</a> 上传代码到git仓库, 配置公钥无密码拉取代码</h3> <p>api server代码独立新建个仓库出来 , 用国内的git仓库速度快 gitee.com</p> <p><code>hendrycode / vivitek_solution_server</code></p> <p>// <code>server目录</code>已经用sourceTree初始化了git仓库
// 注意这个<code>git</code>仓库是在已有的<code>git仓库</code>下的子目录下</p> <p><code>git remote add origin https://gitee.com/hendrycode/vivitek_solution_server.git</code> <code>git push -u origin master</code></p> <p>代码上传后, 服务器上就可以clone下载了, 但是每次下载的时候还需要输入密码, 这样是很不方便的, 要实现自动化部署就必须要用key来进行代码的上传下载</p> <p>在linux机器上生成公钥, 在以前没有手动创建公钥的时候, linux机器默认是有个私钥的 <code>/root/.ssh/id_rsa</code></p> <p>但没有公钥, 我们用命令生成ssh公钥的时候会提示私钥放在哪, 默认还是<code>/root/.ssh/id_rsa</code>, 也就是会覆盖这个文件,</p> <p>因为系统在需要私钥的时候, 默认就是读取这个文件, 所以我们就保持默认即可</p> <p>另外就是我们在服务器端生成一次<code>公钥/私钥</code>,  是可以用在多个项目中的,把公钥添加到项目即可</p> <p>因此尽量把<code>秘钥对</code>保持好且不要再去创建, 那样会导致所有项目都要更新公钥</p> <p>// 创建<code>秘钥对</code></p> <p><code>ssh-keygen -t rsa -C &quot;aliyun server&quot;</code> <code>ssh-agent -s</code> 确认本机<code>ssh-agent</code>在运行</p> <p>运行完成后
私钥 <code>.ssh/id_rsa</code>
公钥 <code>.ssh/id_rsa.pub</code></p> <p>// 添加公钥到gitee.com项目
<code>cat ~/.ssh/id_rsa.pub</code></p> <p>测试下
<code>ssh -T git@gitee.com</code>  返回gitee.com的用户名说明成功</p> <p>新安装的git, 添加全局git用户信息, 提交的时候这些会显示在<code>提交人</code>
git config --global user.name &quot;hendry&quot;
git config --global user.mail &quot;supervisitor.cn@gmail.com&quot;</p> <p>立即让新创建的密钥对在本机生效</p> <p><code>ssh-add ~/.ssh/id_rsa</code></p> <p><code>http://www.cnblogs.com/Security-Darren/p/4106328.html</code></p> <p>另外还有需要注意的是gitee.com 有个项目公钥, 限制了部署时候只能clone和pull更新</p> <p>一般情况我们都是在个人设置里面设置的个人公钥, 那样是可读写的, 项目部署公钥更安全</p> <p>进入仓库, 在项目的管理中加入部署公钥</p> <p>然后测试克隆,   需要注意的是clone的时候要选择git协议的才能使用ssh公钥</p> <p>如果clone地址是https那么是无法使用公钥的</p> <p><code>git clone git@gitee.com:hendrycode/vivitek_solution_server.git</code></p> <p>另外这个仓库是有两个远程仓库的</p> <p><code>git clone git@bitbucket.org:hendry2008/vivitek_solution_server.git</code></p> <p>我们每次本地开发的时候push会推送到gitee.com和bitbucket.com两个远程仓库,</p> <p>且这两个都是配置了公钥无密码拉取代码, 当然首选是gitee, 国内应该速度快, 而且它是部署公钥只能读不能写</p> <h2 id="使用pm2-部署项目"><a href="#使用pm2-部署项目" aria-hidden="true" class="header-anchor">#</a> 使用PM2 部署项目</h2> <p>// 在服务器端安装PM2</p> <p><code>npm install -g pm2</code></p> <p>// watch表示代码有变更就重新启动</p> <p><code>pm2 start bin/www --name 'vivitek_solution_server' --watch</code></p> <p>pm2 list   // 查看已经在运行的项目</p> <p>pm2 delete // 删除再跑的实例</p> <p>pm2 log vivitek_solution_server // 查看日志, 比如 这里mongo连接不上, 日志就有显示</p> <h2 id="pm2设置node-env环境变量-port-端口等"><a href="#pm2设置node-env环境变量-port-端口等" aria-hidden="true" class="header-anchor">#</a> pm2设置NODE_ENV环境变量 PORT 端口等</h2> <p><code>https://www.cnblogs.com/chyingp/p/pm2-documentation.html</code></p> <p>设置自动重启, watch <code>routes</code> 目录, 当该目录下的文件更新后, 自动重启</p> <p>注意要设置工作目录<code>cwd</code>后, <code>watch</code>里面的路径才能生效</p> <p>另外就是我们也只需要对这目录进行watch即可 , 如果是开发需求更新频繁需要重启, 那么索性就用<code>nodemon</code></p> <p>pm2的重启是针对线上环境重启当然不需要那么频繁</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span>        <span class="token operator">:</span> <span class="token string">&quot;vivitek_solution_server&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;script&quot;</span>      <span class="token operator">:</span> <span class="token string">&quot;/root/vivitek_solution_server/bin/www&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;args&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;cwd&quot;</span>         <span class="token operator">:</span> <span class="token string">&quot;/root/vivitek_solution_server&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;PORT&quot;</span><span class="token operator">:</span> <span class="token number">80</span>
  <span class="token punctuation">}</span> <span class="token punctuation">,</span>
 <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;bin&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;routes&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="自动部署"><a href="#自动部署" aria-hidden="true" class="header-anchor">#</a> 自动部署</h2> <p>自动部署指的是本地开发代码变更后 , 让pm2连接到远程服务器且下载代码后自动重启服务端</p> <p>暂时跳过</p> <p>PM2 的配置文件
// ecosystem.json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;apps&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ice&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// project name</span>
            <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;server.js&quot;</span>   <span class="token comment">// 启动脚本</span>
            <span class="token comment">//&quot;instances&quot; : 2 , //  跑几个实例</span>
            <span class="token property">&quot;env&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;COMMON_VARIABLE&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;env_production&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deploy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;production&quot;</span> <span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;imooc_manager&quot;</span> <span class="token punctuation">,</span> <span class="token comment">// 登陆到本机的用户</span>
            <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 远程服务器地址</span>
            <span class="token property">&quot;ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;origin/master&quot;</span> <span class="token punctuation">,</span>  <span class="token comment">// 分支</span>
            <span class="token property">&quot;repo&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;git clone git@gitee.com:hendrycode/vivitek_solution_server.git&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 仓库</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/www/ice/production&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ssh_options&quot;</span><span class="token operator">:</span> <span class="token string">&quot;StrictHostKeyChecking=no&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 避免clone分支的时候检查host</span>
            <span class="token property">&quot;post-deploy&quot;</span><span class="token operator">:</span><span class="token string">&quot;npm install&quot;</span> <span class="token punctuation">,</span> <span class="token comment">//在每次发布后运行命令, 比如安装依赖</span>
            <span class="token property">&quot;pre-deploy-local&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo 'Deploy done!'&quot;</span> <span class="token punctuation">,</span> <span class="token comment">// 本地在发布之前运行一些命令, 比如压缩, 编译等等</span>
            <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mongodb-数据的导出导入"><a href="#mongodb-数据的导出导入" aria-hidden="true" class="header-anchor">#</a> mongodb 数据的导出导入</h2> <p><code>http://blog.51yip.com/nosql/1573.html</code></p> <ul><li><p>导出
<code>mongodump -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件存在路径</code></p> <p>我们导出本地默认端口的数据库, 在本地开发机器linux 192.168.12.222 机器上导出</p> <p><code>mongodump -d vivitek_solution -o vivitek_solution.db</code> // -o 指定输出目录</p> <p>如果不指定<code>-o</code> 参数 , 默认会把导出的文件放在当前目录下的dump目录(会自动新建该目录)</p></li> <li><p>导入</p> <p>先把导出的文件压缩且scp到线上服务器
<code>tar zcvf vivitek_solution.db.tgz vivitek_solution.db</code> <code>scp -P9999 vivitek_solution.db.tgz msg.qtrouter.com:/root</code>
服务器上解压后导入
<code>mongorestore -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 --drop 文件存在路径</code></p> <p>如</p> <p><code>mongorestore -d vivitek_solution ./vivitek_solution.db/vivitek_solution</code></p> <p>如果要删除后重新恢复则用--drop参数</p> <p>恢复成功后, mongo 进去看看数据都已经存在了</p> <p>然后修改server的mongodb连接的代码, 因为本地开发环境mongodb server 是192.168.12.222,
现在线上服务器和数据库是跑在同个机器上的因此改成<code>127.0.0.1</code> , 修改后测试 <code>http://msg.qtrouter.com:3333/api/product/cates</code>
能获取数据说明API 地址可用</p></li></ul> <h2 id="mongodb-账号密码登陆"><a href="#mongodb-账号密码登陆" aria-hidden="true" class="header-anchor">#</a> mongodb 账号密码登陆</h2> <p><code>http://blog.51cto.com/hld1992/2074619</code> <code>https://www.jianshu.com/p/79caa1cc49a5</code></p> <p>在刚安装完毕的时候，MongoDB都默认有一个admin数据库,此时admin数据库是空的,没有记录权限相关的信息。当集合admin.system.users中一个用户都没有时，
即使mongod启动时添加了—auth参数,如果没有在admin数据库中添加用户,此时不进行任何认证还是可以做任何操作(不管是否是以—auth 参数启动),
直到在admin.system.users中添加了一个用户。加固的核心是只有在admin.system.users中添加用户之后，mongodb的认证,授权服务才能生效。</p> <p>centos 默认配置mongodb只在本地127.0.0.1地址监听</p> <p>首先需要配置数据库服务器需要认证密码 ,  mongod命令行加入启动时参数 <code>--auth</code>, 如</p> <p><code>mongod -f /etc/mongod.conf --auth</code>  // 指定配置文件, 指定需要验证登陆数据库</p> <p>// centos 下修改配置文件开启验证, 在配置了管理员用户后再开启</p> <h3 id="centos-7-开启mongodb-auth参数"><a href="#centos-7-开启mongodb-auth参数" aria-hidden="true" class="header-anchor">#</a> centos 7 开启mongodb auth参数</h3> <p>这篇是centos7下的操作比较全面, 还包括系统参数的设置</p> <p><code>https://www.howtoforge.com/tutorial/how-to-install-and-configure-mongodb-on-centos-7/</code></p> <p>// centos 7 <code>/usr/lib/systemd/system/mongod.service</code></p> <p>在服务启动文件中找到<code>OPTIONS</code></p> <p>改为
<code>OPTIONS=&quot; --auth -f $CONFIGFILE&quot;</code></p> <p>先以非认证方式启动数据库, 然后添加<code>管理员用户</code></p> <div class="language-js extra-class"><pre class="language-js"><code>mongo  <span class="token comment">// 进入mongo shell</span>
use admin   <span class="token comment">// 使用admin数据库</span>
<span class="token comment">// 根据实际情况添加管理员用户</span>
db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    user<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>
    pwd<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>
    roles<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> role<span class="token punctuation">:</span> <span class="token string">&quot;userAdminAnyDatabase&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>   <span class="token comment">// 返回1表示成功</span>
</code></pre></div><p>给需要认证的数据库单独添加用户</p> <div class="language-js extra-class"><pre class="language-js"><code>use vivitek_solution
db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token punctuation">:</span><span class="token string">&quot;vivitek_solution_user&quot;</span><span class="token punctuation">,</span>
    pwd<span class="token punctuation">:</span><span class="token string">&quot;0112358&quot;</span><span class="token punctuation">,</span>
    roles<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>role<span class="token punctuation">:</span><span class="token string">&quot;dbOwner&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span><span class="token string">&quot;vivitek_solution&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;vivitek_solution_user&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0112358&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>修改密码</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token string">&quot;vivitek_solution_user&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    pwd<span class="token punctuation">:</span><span class="token string">&quot;vivitek0112358&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;vivitek_solution_user&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0112358&quot;</span><span class="token punctuation">)</span>      <span class="token comment">//错误</span>
db<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;vivitek_solution_user&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;vivitek0112358&quot;</span><span class="token punctuation">)</span>  <span class="token comment">//登陆成功</span>
</code></pre></div><ul><li>设置数据库需要用户验证</li></ul> <p><code>/usr/lib/systemd/system/mongod.service</code></p> <p>在服务启动文件中找到OPTIONS</p> <p>改为
<code>OPTIONS=&quot; --auth -f $CONFIGFILE&quot;</code></p> <div class="language-js extra-class"><pre class="language-js"><code>systemctl daemon<span class="token operator">-</span>reload
systemctl restart mongod
</code></pre></div><p>当重启mongod后, 终端输入mongo进入到mongo shell, 但是此时比如查看数据库  show dbs 会提示错误</p> <p>我们需要登陆验证</p> <p><code>db.auth(&quot;admin&quot;, &quot;password&quot;)</code> 验证通过后才能进行数据库的操作</p> <p>那么<code>mongoose</code> 连接也要修改, 直接参考mongoose官网的文档即可
<code>http://mongoosejs.com/docs/connections.html</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> user<span class="token operator">=</span><span class="token string">&quot;vivitek_solution_user&quot;</span>
<span class="token keyword">const</span> pwd<span class="token operator">=</span><span class="token string">&quot;vivitek0112358&quot;</span>
<span class="token keyword">const</span> mongo_url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`mongodb://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pwd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
</code></pre></div><h2 id="mongoose-区分发环境和线上环境"><a href="#mongoose-区分发环境和线上环境" aria-hidden="true" class="header-anchor">#</a> mongoose 区分发环境和线上环境</h2> <p>思路是这样的, 在启动的时候传递参数给启动文件</p> <p>启动文件中根据参数来设置环境变量</p> <p>这样我们在连接数据库的时候, 就可以判断环境变量, 从而设置不同的数据库连接</p> <p><code>https://blog.xinshangshangxin.com/2015/09/19/node%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%8F%82%E6%95%B0%E8%8E%B7%E5%8F%96/</code> <code>http://fred.itxfd.com/2016/08/10/node-pm2-%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/</code></p> <p>// <code>vivitek_solution_server.json</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;apps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vivitek_solution_server&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/root/vivitek_solution_server/bin/www&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;args&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>让pm2读取配置文件启动</p> <p><code>pm2 start vivitek_solution_server.json</code></p> <p>这样, <code>bin/www</code> 就能获取到这个参数, 获取到这个参数我们就把node环境设置为product</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> product_argv <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>product_argv <span class="token operator">==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;production ...&quot;</span><span class="token punctuation">)</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span>
<span class="token punctuation">}</span>

</code></pre></div><p>// <code>db.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> mongo_url <span class="token operator">=</span> <span class="token string">&quot;mongodb://192.168.12.222/vivitek&quot;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mongo_url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`mongodb://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pwd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
<span class="token punctuation">}</span>

</code></pre></div><p>参考前面文章其实可以直接使用PM2 传递环境变量, 当然我们这样传递参数的方式也并不冲突</p> <p>完成部署后测试 <code>http://msg.qtrouter.com:3333/api/product/cates/</code></p> <p>对pm2还需要深入使用, 它的参数传递和结合git进行自动部署还是值得使用的</p> <h2 id="app端配置线上的api地址"><a href="#app端配置线上的api地址" aria-hidden="true" class="header-anchor">#</a> APP端配置线上的API地址</h2> <h2 id="安装node"><a href="#安装node" aria-hidden="true" class="header-anchor">#</a> 安装node</h2> <p>按对应版本选择 <code>https://nodejs.org/en/download/</code></p> <p>如 linux 64位:</p> <p><code>https://nodejs.org/dist/v6.10.3/node-v6.10.3-linux-x64.tar.xz</code></p> <h3 id="解压"><a href="#解压" aria-hidden="true" class="header-anchor">#</a> 解压</h3> <p><code>xz -d node-v6.10.3-linux-x64.tar.xz</code> <code>tar xvf node-v6.10.3-linux-x64.tar</code></p> <h3 id="node添加到path"><a href="#node添加到path" aria-hidden="true" class="header-anchor">#</a> node添加到path</h3> <p>先确认node解压路径</p> <p><code>/root/soft/node-v6.10.3-linux-x64/bin</code></p> <p>然后在<code>/etc/profile</code>中<code>export</code>的<code>上一行</code>添加 (大概是55行)</p> <p><code>PATH=$PATH:/root/soft/node-v6.10.3-linux-x64/bin</code></p> <p>然后让path生效 ,  <code>source /etc/profile</code></p> <p>此时 node 和 npm 都能像平时一样使用了</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f8bee57c.js" defer></script><script src="/assets/js/56.bc578093.js" defer></script>
  </body>
</html>
