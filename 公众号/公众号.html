<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信公众号 | 工作笔记</title>
    <meta name="description" content="Hendry的博客">
    <link rel="icon" href="/img/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.eecf6a6a.css" as="style"><link rel="preload" href="/assets/js/app.f8bee57c.js" as="script"><link rel="preload" href="/assets/js/11.bbd08110.js" as="script"><link rel="prefetch" href="/assets/js/10.837bbfd0.js"><link rel="prefetch" href="/assets/js/12.eb514b46.js"><link rel="prefetch" href="/assets/js/13.e2503408.js"><link rel="prefetch" href="/assets/js/14.d97c0ac2.js"><link rel="prefetch" href="/assets/js/15.baf7986f.js"><link rel="prefetch" href="/assets/js/16.2b12bf6f.js"><link rel="prefetch" href="/assets/js/17.f7e545ac.js"><link rel="prefetch" href="/assets/js/18.70d9230d.js"><link rel="prefetch" href="/assets/js/19.0a61e7ba.js"><link rel="prefetch" href="/assets/js/2.d139c70a.js"><link rel="prefetch" href="/assets/js/20.87141f48.js"><link rel="prefetch" href="/assets/js/21.536e6d3b.js"><link rel="prefetch" href="/assets/js/22.fa3e648a.js"><link rel="prefetch" href="/assets/js/23.f6c367b9.js"><link rel="prefetch" href="/assets/js/24.a8f770f5.js"><link rel="prefetch" href="/assets/js/25.3bb8bbfc.js"><link rel="prefetch" href="/assets/js/26.1c16cfb8.js"><link rel="prefetch" href="/assets/js/27.075df559.js"><link rel="prefetch" href="/assets/js/28.90c1e366.js"><link rel="prefetch" href="/assets/js/29.3145e78e.js"><link rel="prefetch" href="/assets/js/3.de89ea98.js"><link rel="prefetch" href="/assets/js/30.9832e5bd.js"><link rel="prefetch" href="/assets/js/31.2f9a7c5b.js"><link rel="prefetch" href="/assets/js/32.df9181b5.js"><link rel="prefetch" href="/assets/js/33.ec53f96d.js"><link rel="prefetch" href="/assets/js/34.398a7128.js"><link rel="prefetch" href="/assets/js/35.bb1c5a48.js"><link rel="prefetch" href="/assets/js/36.935a5449.js"><link rel="prefetch" href="/assets/js/37.459fef35.js"><link rel="prefetch" href="/assets/js/38.f51023c1.js"><link rel="prefetch" href="/assets/js/39.ed9f7023.js"><link rel="prefetch" href="/assets/js/4.a889cc83.js"><link rel="prefetch" href="/assets/js/40.7959ecc5.js"><link rel="prefetch" href="/assets/js/41.2f350c5b.js"><link rel="prefetch" href="/assets/js/42.3a09f5a5.js"><link rel="prefetch" href="/assets/js/43.b22e3395.js"><link rel="prefetch" href="/assets/js/44.ea91f873.js"><link rel="prefetch" href="/assets/js/45.29363c9f.js"><link rel="prefetch" href="/assets/js/46.45848afe.js"><link rel="prefetch" href="/assets/js/47.309f8db5.js"><link rel="prefetch" href="/assets/js/48.4da217ee.js"><link rel="prefetch" href="/assets/js/49.713e67fd.js"><link rel="prefetch" href="/assets/js/5.7183a5fb.js"><link rel="prefetch" href="/assets/js/50.d90574c6.js"><link rel="prefetch" href="/assets/js/51.5190cc6c.js"><link rel="prefetch" href="/assets/js/52.25c37497.js"><link rel="prefetch" href="/assets/js/53.3fea90a3.js"><link rel="prefetch" href="/assets/js/54.d23ad054.js"><link rel="prefetch" href="/assets/js/55.d8ba3a31.js"><link rel="prefetch" href="/assets/js/56.bc578093.js"><link rel="prefetch" href="/assets/js/57.cb8c611e.js"><link rel="prefetch" href="/assets/js/58.4a6efece.js"><link rel="prefetch" href="/assets/js/59.397f12f2.js"><link rel="prefetch" href="/assets/js/6.6621a9ba.js"><link rel="prefetch" href="/assets/js/60.a209bb60.js"><link rel="prefetch" href="/assets/js/61.0a1b1f3b.js"><link rel="prefetch" href="/assets/js/62.a79409e9.js"><link rel="prefetch" href="/assets/js/63.f99fda12.js"><link rel="prefetch" href="/assets/js/64.59a96a9c.js"><link rel="prefetch" href="/assets/js/65.ab4be186.js"><link rel="prefetch" href="/assets/js/66.df4455cd.js"><link rel="prefetch" href="/assets/js/7.a024304b.js"><link rel="prefetch" href="/assets/js/8.be16c405.js"><link rel="prefetch" href="/assets/js/9.37e77487.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eecf6a6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">工作笔记</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/menu.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/Android/" class="nav-link">Android</a></div><div class="nav-item"><a href="/直播/" class="nav-link">直播</a></div><div class="nav-item"><a href="/前端/" class="nav-link">前端</a></div><div class="nav-item"><a href="/公众号/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/项目/" class="nav-link">项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">冒泡</a></li><li class="dropdown-subitem"><a href="/language/japanese.html" class="nav-link">快速</a></li></ul></li><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">工厂</a></li><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">单例</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/menu.html" class="nav-link">首页</a></div><div class="nav-item"><a href="/Android/" class="nav-link">Android</a></div><div class="nav-item"><a href="/直播/" class="nav-link">直播</a></div><div class="nav-item"><a href="/前端/" class="nav-link">前端</a></div><div class="nav-item"><a href="/公众号/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/项目/" class="nav-link">项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">冒泡</a></li><li class="dropdown-subitem"><a href="/language/japanese.html" class="nav-link">快速</a></li></ul></li><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">工厂</a></li><li class="dropdown-subitem"><a href="/language/chinese.html" class="nav-link">单例</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>微信公众号</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#资源" class="sidebar-link">资源</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#环境" class="sidebar-link">环境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#公众号的常见功能和其实现流程" class="sidebar-link">公众号的常见功能和其实现流程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#被动消息" class="sidebar-link">被动消息</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#认证和接口权限" class="sidebar-link">认证和接口权限</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#接入服务器" class="sidebar-link">接入服务器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#微信消息架构" class="sidebar-link">微信消息架构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#微信分享" class="sidebar-link">微信分享</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#签名算法规则" class="sidebar-link">签名算法规则</a></li></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#获取-access-token" class="sidebar-link">获取 access_token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#js-sdk-使用权限签名" class="sidebar-link">JS-SDK 使用权限签名</a></li><li class="sidebar-sub-header"><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#获取-jsticket" class="sidebar-link">获取 jsticket</a></li></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#服务器端渲染测试微信分享" class="sidebar-link">服务器端渲染测试微信分享</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#测试公众号新建菜单跳转页面" class="sidebar-link">测试公众号新建菜单跳转页面</a></li><li class="sidebar-sub-header"><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#移动客户端微信分享" class="sidebar-link">移动客户端微信分享</a></li></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#html5plus" class="sidebar-link">html5plus</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#二维码" class="sidebar-link">二维码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%85%AC%E4%BC%97%E5%8F%B7/%E5%85%AC%E4%BC%97%E5%8F%B7.html#微信二维码-demo" class="sidebar-link">微信二维码 demo</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="微信公众号"><a href="#微信公众号" aria-hidden="true" class="header-anchor">#</a> 微信公众号</h1> <h2 id="资源"><a href="#资源" aria-hidden="true" class="header-anchor">#</a> 资源</h2> <p>主文档</p> <p>公众号中的流程, AccessToken, OpenId 等概念</p> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main</code></p> <p><code>js</code> 开发公众号</p> <p><code>https://www.jianshu.com/p/a172a1b69fdd</code></p> <p><code>php</code>开发公众号</p> <p><code>https://github.com/netputer/wechat-php-sdk</code></p> <h2 id="环境"><a href="#环境" aria-hidden="true" class="header-anchor">#</a> 环境</h2> <p>从<code>测试公众号</code>开始</p> <p>因为自己申请的公众号还涉及接口权限问题, 反而测试公众号更方便</p> <p>申请地址
<code>http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login</code></p> <p>打开页面后, 微信扫二维码登陆, 登陆后 pc 端跳转到测试号管理页面</p> <p>就能得到<code>appID</code> <code>appsecret</code> 等信息</p> <p>appID : <code>wxe368debba7c867f6</code></p> <p>appsecret: <code>7780d255a46794e94a638db6eaa08896</code></p> <h2 id="公众号的常见功能和其实现流程"><a href="#公众号的常见功能和其实现流程" aria-hidden="true" class="header-anchor">#</a> 公众号的常见功能和其实现流程</h2> <p>首先所有的公众号的功能都必须经过<code>开发者服务器</code></p> <p>该<code>开发服务器</code>的作用就是提供公众号服务</p> <p>但是用户是不能直接和<code>开发服务器</code>交互的, 用户只能和微信交互</p> <p><code>微信服务器</code>就像是个中间代理, 进行消息转发和提供接口</p> <p>那么微信服务器第一步就是要验证我们的<code>开发服务器</code></p> <p>验证的时候, 需要我们在后台提供服务器的 url 地址</p> <p>还有我们自主设置的 <code>token</code> , 然后和微信服务器通信, 如果通信后验证信息一致,</p> <p>那么微信服务器就会和<code>开发服务器</code>建立信任关系</p> <p><code>Token</code>：自主设置，这个<code>token</code>与公众平台<code>wiki</code>中常提的<code>access_token</code>不是一回事。这个<code>token</code>只用于验证开发者服务器。</p> <p>但这部分在测试公众号里是没有的</p> <p>看来开发环境, 最好是一个普通的开发订阅号 加上一个测试公众号</p> <p>开发订阅号, 可以用来测试基本的服务器验证和消息推送</p> <p>测试公众号用来进行商城和预约等复杂页面的测试</p> <h2 id="被动消息"><a href="#被动消息" aria-hidden="true" class="header-anchor">#</a> 被动消息</h2> <p>粉丝给公众号一条文本消息，公众号立马回复一条文本消息给粉丝，不需要通过公众平台网页操作。</p> <p>被动回复消息流程图: 文档 <code>https://mp.weixin.qq.com/wiki?t=resource/res_main</code> (注意看 2.4 流程图)</p> <p>文本消息格式
<code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140543</code></p> <h2 id="认证和接口权限"><a href="#认证和接口权限" aria-hidden="true" class="header-anchor">#</a> 认证和接口权限</h2> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433401084</code></p> <p>个人申请的订阅号是无法认证的</p> <p>比如常用的<code>分享功能</code> , 用订阅号即可, 但是必须是认证后的订阅号而 <code>帐号主体为个人，无法开通微信认证</code></p> <p>简单说, 个人身份注册订阅号, 无法认证, 无法使用<code>分享接口</code>更别提微信支付</p> <p>所以, 个人申请的订阅号是没有任何意义的, 不知道为什么还要保留个人身份注册的订阅号</p> <p>而目前代码测试, 申请的都是个人身份订阅号, 只能说有个后台可以进去看看</p> <p>那么无法得到<code>微信认证订阅号</code>的情况下, 只能用<code>微信测试账号</code>来进行开发了</p> <h2 id="接入服务器"><a href="#接入服务器" aria-hidden="true" class="header-anchor">#</a> 接入服务器</h2> <p>登陆测试账号
<code>http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login</code></p> <p>虽然是测试账号, 但是基本流程是一样的, 首先需要配置<code>接入服务器</code></p> <p>验证接入服务器:</p> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319</code></p> <p>首先在微信后台(这里就是测试账号后台)需要我们配置<code>自定义token</code> 和 <code>我们的服务器URL</code>;</p> <p>当我们配置 token 后, <code>微信服务器</code>会把这个<code>token</code> 生成签名<code>字符串signature</code></p> <p>并且,微信服务器将发送<code>GET请求</code>到填写的服务器地址 URL 上(也就是访问我们的服务器 url)</p> <p>从而我们就能获取到<code>微信服务器</code>发送给我们的参数,然后我们要按文档要求来验证微信服务器发送过来的参数</p> <p>验证通过后, 我们还需要原样返回<code>echostr参数</code>内容, 则接入生效</p> <p>例如:</p> <p>接入 URL <code>http://vivitek.qtrouter.com/weixin/init</code> (URL 必须是 http 或 https 分别是 80 和 443 端口, 其他的端口不行)
token: vivitektest</p> <p>当在后台配置了 URL 后, 我们的 express 服务器打印 log 可以看到下面来自微信服务器的请求</p> <ul><li>注意: 可能是为了方便测试, 每次点击微信公众平台后台的提交按钮都会发送一次 get 请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">GET</span> <span class="token operator">/</span>weixin<span class="token operator">/</span>init<span class="token operator">?</span>signature<span class="token operator">=</span><span class="token number">0</span>deb7cd6f85b980e27793559afc92fdcf5a1ee07<span class="token operator">&amp;</span>echostr<span class="token operator">=</span><span class="token number">3056921134620933819</span><span class="token operator">&amp;</span>timestamp<span class="token operator">=</span><span class="token number">1528208057</span><span class="token operator">&amp;</span>nonce<span class="token operator">=</span><span class="token number">3412872865</span>
</code></pre></div><p>那么我们需要做的就是按文档来验证签名<code>signature</code> , 如果验证通过, 那么我们就返回<code>echostr</code></p> <p>1）将 token、timestamp、nonce 三个参数进行字典序排序</p> <p>2）将三个参数字符串拼接成一个字符串进行 sha1 加密</p> <p>3）开发者获得加密后的字符串可与 signature 对比</p> <p><code>sha1</code> 加密</p> <p><code>https://stackoverflow.com/questions/6984139/how-can-i-get-the-sha1-hash-of-a-string-in-node-js</code></p> <p>使用 node 自带的模块<code>crypto</code> , 直接 require 即可</p> <div class="language-js extra-class"><pre class="language-js"><code>shasum <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span> <span class="token comment">//  初始化sha1算法</span>
shasum<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token comment">// 调用算法,传递需要加密的字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>shasum<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获取需要的十六进制字符串</span>
</code></pre></div><h2 id="微信消息架构"><a href="#微信消息架构" aria-hidden="true" class="header-anchor">#</a> 微信消息架构</h2> <p>用户在公众号中的输入语音或者输入文字等, 被当做是事件, 这些事件会被微信服务器端处理为 xml 格式的消息, 发送给我们上面步骤中认证过的服务器</p> <p>服务器在接收到这些事件消息后, 要处理的工作有</p> <ul><li>路由拦截后, 解析 post 消息 , xml 格式的请求体进行解析</li> <li>本地服务器的回复策略</li> <li>获取 AccessToken , 我们的回复消息是需要发送给微信服务器端转发给最终用户, 所以要访问微信服务器就需要这个 AccessToken</li> <li>xml 构建, 当有了 AccessToken 后, 把我们的回复内容进行格式化 xml , 发送给微信服务器 , 于是最终用户将收到微信服务器转发的我们的内容</li></ul> <h2 id="微信分享"><a href="#微信分享" aria-hidden="true" class="header-anchor">#</a> 微信分享</h2> <p>微信分享需要用到的是<code>JSSDK</code> , 它是提供给<code>浏览器</code>端使用的 js 接口, 也包含<code>app</code>端 ,</p> <p>但终端(浏览器和 app 端)在引入和使用 JSSDK 的时候, 必须要有我们自己的后台服务器和微信服务器的交互,</p> <p>终端在调用接口的时候, 是需要一些参数的, 这些参数是由我们的服务器后台和微信服务器的交互来提供的, 所以首先我们应该做后台部分</p> <p>让我们的后台提供必须的参数. 见文档: <code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115</code></p> <p>前端使用 jssdk 在配置的时候, 需要提供<code>signature</code> , 这个签名算法见文档的<code>附录1</code> , 里面详细描述了提供给前端的这个<code>签名</code>怎么生成</p> <p>且强调了<code>出于安全考虑，开发者必须在服务器端实现签名的逻辑</code> . 具体的看文档</p> <p>// 实例:</p> <ul><li><p>首先使用测试账号在后台设置<code>JS接口安全域名</code>, 注意 域名是不需要<code>http://</code> 这部分的 , 只需要域名, 且测试账号只能设置一个接口安全域名</p></li> <li><p>签名:</p></li></ul> <h3 id="签名算法规则"><a href="#签名算法规则" aria-hidden="true" class="header-anchor">#</a> 签名算法规则</h3> <p>签名需要的字段有:</p> <p>noncestr -- 签名用的 noncestr 和 timestamp 必须与 wx.config 中的 nonceStr 和 timestamp 相同</p> <p>timestamp -- 签名用的 noncestr 和 timestamp 必须与 wx.config 中的 nonceStr 和 timestamp 相同</p> <p>url -- 签名用的 url 必须是调用 JS 接口页面的完整 URL</p> <p>jsapi_ticket -- <code>jsapi_ticket</code> 由<code>access_token</code>来生成, 所以需要先按文档来获取<code>access_token</code>(有效期 7200 秒) ,
然后传递<code>access_token</code>给微信公众平台来获取<code>jsapi_ticket</code>(也是有效期 7200 秒)
获取到<code>jsapi_ticket</code>后, 我们需要自己把这个<code>jsapi_ticket</code>进行缓存, 所以需要记录下来<code>jsapi_ticket</code>和它的生成时间</p> <p>当上面的字段都准备好了后:</p> <p>步骤 1. 把上面的字段拼接成字符串
步骤 2. 对 string1 进行 sha1 签名，得到 signature</p> <h2 id="获取-access-token"><a href="#获取-access-token" aria-hidden="true" class="header-anchor">#</a> 获取 access_token</h2> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140183</code></p> <p>获取 access_token 就是访问接口地址, 传递参数正确的话, 访问这个接口地址后它会返回 JSON 字符串</p> <p>https 请求方式: GET
https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> access_token_api_url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>appsecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token comment">// console.log(access_token_api_url)</span>
  axios
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>access_token_api_url<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>保存到数据库 , 新建 weixin 表 collection</p> <p>需要字段有
access_token: access_token
expired_time: 过期的时间戳
created: 保存到数据库时的时间戳</p> <p>// 示例代码</p> <p>测试访问<code>http://vivitek.qtrouter.com/weixin/get-access-token</code> 输出 token, 且缓存保存到了数据库</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get-access-token'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> access_token_api_url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>appsecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token comment">// console.log(access_token_api_url)</span>
  <span class="token comment">// 查询数据库中是否已经存在access_token</span>
  <span class="token comment">// let existed_token = await model_weixin.find({&quot;access_token.expire_time&quot;: {$gt:Date.now()}}); // 这是错误方式, 因为schema是date类型而不是int数字类型</span>
  <span class="token keyword">let</span> existed_doc <span class="token operator">=</span> <span class="token keyword">await</span> model_weixin<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'access_token.expired_time'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existed_doc <span class="token operator">&amp;&amp;</span> existed_doc<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已经存在access_token那么就直接返回access_token</span>
    <span class="token comment">// console.log(existed_doc)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>existed_doc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>access_token<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// console.log(&quot;access api to get access_token&quot;);</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>access_token_api_url<span class="token punctuation">)</span>
    <span class="token keyword">let</span> access_token <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token
    <span class="token comment">// 超时, 返回的的expires_in单位是秒 7200 秒, 也就是2个小时,  而我们数据库记录是毫秒</span>
    <span class="token comment">// 另外我们需要提前一段时间去获取access_token</span>
    <span class="token keyword">let</span> expires_in <span class="token operator">=</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
    <span class="token comment">// console.log(expires_in);</span>
    <span class="token comment">// console.log(access_token)</span>
    <span class="token comment">// 把access_token 存入到数据库</span>
    <span class="token keyword">let</span> token_doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">model_weixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      access_token<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        access_token<span class="token punctuation">:</span> access_token<span class="token punctuation">,</span>
        expired_time<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires_in<span class="token punctuation">,</span>
        created<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 保存到数据库</span>
    <span class="token keyword">await</span> token_doc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 且返回从微信服务器获取的access_token</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="js-sdk-使用权限签名"><a href="#js-sdk-使用权限签名" aria-hidden="true" class="header-anchor">#</a> JS-SDK 使用权限签名</h3> <p>终端在使用<code>jssdk</code>的时候, 需要配置签名字段<code>signature</code></p> <p>这个签名由我们自己的后台来生成, 这个签名需要先访问<code>微信平台</code>API 获取 <code>jsapi_ticket</code> , <code>timestamp</code> 等字段后经过加密算法来生成</p> <p>获取<code>jsapi_ticket</code> 等字段</p> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115</code> (附录 1)</p> <p><code>jsapi_ticket</code>是公众号用于调用微信 JS 接口的临时票据
<code>jsapi_ticket</code>的有效期为 7200 秒 通过 access_token 来获取
获取<code>jsapi_ticket</code>的<code>api</code>调用次数非常有限,开发者必须在自己的服务全局缓存<code>jsapi_ticket</code></p> <p>字符串拼接
<code>https://nodejs.org/api/querystring.html</code></p> <p>手动循环拼接 , 或者用<code>querystring</code> 模块的<code>stringify</code> 来拼接 , 但拼接的时候会默认进行<code>encode</code> , 而这个编码是不需要的, 所以调用<code>stringify</code>的时候可以传递<code>encode</code>自定义函数直接返回字符串本身即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>
<span class="token comment">// function(str){return str} 可以简写 str =&gt; str</span>
<span class="token comment">// 因为箭头函数本身就有隐式return语句</span>
<span class="token keyword">let</span> paramString <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sorted_obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">encodeURIComponent</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>// 获取签名等参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成签名需要的参数noncestr 客户端和服务器端必须一致, 因此会在服务器端生成, 然后传递给客户端</span>
<span class="token comment">// 需要的参数url 是客户端传递过来的, 一般就是客户端访问的当前url地址, 且必须是完整地址</span>
<span class="token comment">// 所以这里把这些参数统一返回给客户端保证一致性</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getJsApiConfigParam</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> noncestr <span class="token operator">=</span> <span class="token string">'Wm3WZYTPz0wzccnW'</span>
  <span class="token keyword">let</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// let url = req.originalUrl;</span>
  <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJsApiSignature</span><span class="token punctuation">(</span>noncestr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    appid<span class="token punctuation">:</span> config<span class="token punctuation">.</span>appid<span class="token punctuation">,</span>
    timestamp<span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span>
    noncestr<span class="token punctuation">:</span> noncestr<span class="token punctuation">,</span>
    signature<span class="token punctuation">:</span> signature
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取JS-SDK使用权限签名</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getJsApiSignature</span><span class="token punctuation">(</span><span class="token parameter">noncestr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> jsapi_ticket <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJsTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    noncestr<span class="token punctuation">:</span> noncestr<span class="token punctuation">,</span>
    jsapi_ticket<span class="token punctuation">:</span> jsapi_ticket<span class="token punctuation">,</span>
    timestamp<span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> url
  <span class="token punctuation">}</span>

  <span class="token comment">// 字典排序</span>
  <span class="token keyword">let</span> sorted_keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> sorted_obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> sorted_keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sorted_obj<span class="token punctuation">[</span>sorted_keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>sorted_keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 生成文档中要求的拼接字符串, 注意是没有编码格式的字符串</span>
  <span class="token comment">// jsapi_ticket=HoagFKDcsGMVCIY2vOjf9vKli_eitPrGyCHJh4k_IrD90WSotAl-EN40Y2kpmAhB84U_Bs7uTmyO2pq2MfFBAg&amp;noncestr=Wm3WZYTPz0wzccnW&amp;timestamp=1528429071103&amp;url=/get-jsapi-signature</span>
  <span class="token keyword">let</span> paramString <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sorted_obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">encodeURIComponent</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> str
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// console.log(querystring.unescape(paramString));</span>
  <span class="token comment">// console.log(paramString);</span>
  <span class="token comment">// 对拼接字符串进行sha1签名得到签名字符串</span>
  <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token function">getSha1Str</span><span class="token punctuation">(</span>paramString<span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="获取-jsticket"><a href="#获取-jsticket" aria-hidden="true" class="header-anchor">#</a> 获取 jsticket</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get-jsticket'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> jsTicket <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJsTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>jsTicket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 获取jsticket 这个是生成js调用权限签名的必要参数</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getJsTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首先判断是否已经存在有数据库中缓存的jsticket</span>
    <span class="token comment">// 查找没有过期的jsticket</span>
    <span class="token keyword">let</span> existed <span class="token operator">=</span> <span class="token keyword">await</span> model_weixin_jsticket<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      expired_time<span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'jsticket existed:'</span><span class="token punctuation">,</span> existed<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existed <span class="token operator">&amp;&amp;</span> existed<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>existed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ticket<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若没有可用的ticket则从api获取</span>
    <span class="token keyword">let</span> access_token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log(&quot;access_token:&quot;, access_token);</span>
    <span class="token keyword">const</span> jsapi_ticket_api <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=jsapi`</span></span>
    <span class="token comment">// console.log(&quot;jsapi_ticket_api:&quot;, jsapi_ticket_api);</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jsapi_ticket_api<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// throw new Error(&quot;get jsapi_ticket error&quot;)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get jsapi_ticket error , errcode:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>errcode<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'get jsapi_ticket error , errcode:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>errcode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回结果正常则保存到数据库缓存起来</span>
    <span class="token keyword">let</span> ticket <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response.data.:'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">let</span> expires_in <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
    <span class="token keyword">let</span> jsticket_doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">model_weixin_jsticket</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      ticket<span class="token punctuation">:</span> ticket<span class="token punctuation">,</span>
      expired_time<span class="token punctuation">:</span> expires_in<span class="token punctuation">,</span>
      created<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> jsticket_doc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getJsTicket error: '</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="服务器端渲染测试微信分享"><a href="#服务器端渲染测试微信分享" aria-hidden="true" class="header-anchor">#</a> 服务器端渲染测试微信分享</h2> <p>需要准备客户端页面, 这里先使用 express ejs 模板做输出页面</p> <p>在这个页面中加载 jssdk , 获取签名和参数等</p> <ol><li><p>绑定域名, 域名不包括<code>http://</code>部分</p></li> <li><p>引入 JS 文件<code>http://res.wx.qq.com/open/js/jweixin-1.2.0.js</code>
和 jquery, 因为需要访问我们后台获取签名, 所以这里用 jquery 来发送 ajax 请求, 所以需要引入 jquery, 如果是前端那就用 axios 即可</p></li> <li><p>在<code>需要共享</code>的页面 , js 访问我们的后台提供签名的地址, 获取签名, 然后</p></li></ol> <ul><li>设置<code>wx.config</code></li> <li>设置<code>wx.ready</code>的<code>回调方法</code>中先设置<code>分享的内容</code> ( title, desc, link, image 等) , 然后设置回调方法 <code>wx.onMenuShareTimeline</code> , <code>wx.onMenuShareAppMessage</code></li></ul> <p>注意: 在写客户端的时候可以发现微信分享实际上起关键作用的, 只是设置了两个回调方法 <code>wx.onMenuShareTimeline</code> 和 <code>wx.onMenuShareAppMessage</code>
而没有触发方法, 就是说微信分享<code>jssdk</code>只是提供接口让我们设置<code>分享内容</code> , 而分享的触发是由<code>微信浏览器</code>来触发的, 或者其他的一些浏览器也有分享按钮来触发
而微信<code>jssdk</code>我们一系列的操作, 只是在设置分享的<code>响应</code>, <code>签名</code>和各种访问微信接口配置, 都只是在设置<code>合法的分享内容</code>
但是却不希望给我们自定义触发</p> <p>所以先只能在微信中测试分享, 那么我们可以先关注<code>测试公众号</code>, 然后通过接口给这个<code>测试公众号</code>设置菜单</p> <p>普通的正常公众号设置菜单是通过后台设置, 但是这里是<code>测试公众号</code>, 我们只能用<code>测试接口</code>来设置菜单</p> <p>另外<code>服务号</code>可以后台直接设置跳转, 我们这里只能通过设置<code>点击菜单</code>后的跳转</p> <p>当访问到我们需要分享的页面 , 这个页面已经写好了 js , 而且 wx.config 设置了<code>debug: true</code> , 那么这个页面加载的时候如果分享配置没有问题, 会自动弹出对话框</p> <p>当点击微信右上角进行分享的时候, 也会判断我们 js 代码, 会自动弹出调试信息</p> <h3 id="测试公众号新建菜单跳转页面"><a href="#测试公众号新建菜单跳转页面" aria-hidden="true" class="header-anchor">#</a> 测试公众号新建菜单跳转页面</h3> <p>参考: <code>https://my.oschina.net/u/3606759/blog/1491179</code></p> <p><code>https://www.jianshu.com/p/365d0aa5c11b</code> /微信 web 开发者工具 需要看看</p> <p>debuy 页面: <code>https://mp.weixin.qq.com/debug/</code></p> <p>debug 页面中接口调用需要 access-token, 访问我们自己的后台方法把 access-token 打印出来</p> <p><code>http://vivitek.qtrouter.com/weixin/get-access-token</code></p> <p>然后在 debug 页面接口类型选择 <code>自定义菜单</code> -- <code>自定义菜单创建接口menu/create</code></p> <p>填入下面格式 json 运行后, 我们的<code>测试公众号</code>就有菜单了, 且点击后会跳转到指定 url</p> <p>// 具体的客户端 demo 代码看 vivitek_solution 的 server 的<code>share-test.ejs</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;button&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HendryCodeTest&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;V1001_TODAY_MUSIC&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sub_button&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;菜单&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sub_button&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://vivitek.qtrouter.com&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;sub_button&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;测试分享&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://vivitek.qtrouter.com/weixin/share-test&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;sub_button&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="移动客户端微信分享"><a href="#移动客户端微信分享" aria-hidden="true" class="header-anchor">#</a> 移动客户端微信分享</h3> <blockquote><p>微信的移动端分享放在产品详情页面, 在 mounted 里面就可以用来设置<code>微信分享</code> , 但有异步获取的数据, 所以改到了 watch 里面 , 只要<code>详情数据返回</code>, 我们就马上设置<code>微信分享</code>
在微信浏览器测试通过, 类似的我们可以把其他的几个分享也设置一下, //TODO: 其他页面的微信分享可以直接分享主页</p></blockquote> <p>相关资源:</p> <p><code>http://ask.dcloud.net.cn/article/36</code> <code>https://blog.csdn.net/zhuming3834/article/details/51706256</code></p> <p>前面就提到了<code>微信分享</code>的触发, 需要在微信浏览器或者其他浏览器进行触发</p> <p>那么在我们自己打包的 APP 里面怎么才能触发呢? 我们先按常规流程来看看</p> <p><code>http://obkoro1.com/2017/12/16/vue-%E9%A1%B9%E7%9B%AE%E5%A6%82%E4%BD%95%E5%BC%95%E5%85%A5%E5%BE%AE%E4%BF%A1sdk%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB%E6%8E%A5%E5%8F%A3/</code></p> <p><code>https://gitissue.com/issues/5ab609afefbdd46ca4725b98</code> <code>https://github.com/Chooin/wechat-spa</code></p> <p>比如我们的 vivitek_solution 产品详情页需要进行分享</p> <p><code>src/components/ProductDetail/ProductDetail.vue</code></p> <p>但这个依然是无法通过 WEB 页面触发的, 它只是配置了分享的内容</p> <p>我们把整个 APP 项目编译后放到服务器上, 也就是后台服务器, 且 domain 已经添加到了 jssdk 域名, 可以进行测试</p> <p>但这些都只能确保页面能被微信浏览器内的分享按钮进行分享 , 依然是不能通过页面触发分享的</p> <p>// 测试时是点击页头的分享按钮来执行 share 方法, 但这实际上是无法触发分享的
// 总之 web 触发页面分享是不行的, 必须要原生接口才行
// 调用原生接口的话要么用 shareSDK , 要么就是 HBUILDER</p> <div class="language-js extra-class"><pre class="language-js"><code>      <span class="token keyword">async</span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        console.log(this.$route.path)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
        <span class="token keyword">let</span> share_link <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
        <span class="token comment">// 分享需要的数据</span>
        <span class="token keyword">let</span> share_info <span class="token operator">=</span> <span class="token punctuation">{</span>
          title<span class="token punctuation">:</span> <span class="token string">&quot;vivitek &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_model <span class="token operator">+</span> <span class="token string">&quot; 投影仪&quot;</span><span class="token punctuation">,</span>
          desc<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_desc<span class="token punctuation">,</span>
          fullPath<span class="token punctuation">:</span> share_link<span class="token punctuation">,</span>
          imgUrl<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_img<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getWxConfigApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>url<span class="token punctuation">:</span> share_link<span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          debug<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          appId<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>appId<span class="token punctuation">,</span>
          timestamp<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span>
          nonceStr<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span>
          signature<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>signature<span class="token punctuation">,</span>
          jsApiList<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'onMenuShareTimeline'</span><span class="token punctuation">,</span>
            <span class="token string">'onMenuShareAppMessage'</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          wx<span class="token punctuation">.</span><span class="token function">showAllNonBaseMenuItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          wx<span class="token punctuation">.</span><span class="token function">onMenuShareTimeline</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            link<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            imgUrl<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>imgUrl
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          wx<span class="token punctuation">.</span><span class="token function">onMenuShareAppMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            desc<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>desc<span class="token punctuation">,</span>
            link<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            imgUrl<span class="token punctuation">:</span> share_info<span class="token punctuation">.</span>imgUrl
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>这两个项目都是同一个人的</p> <p><code>https://github.com/vue-html5plus/vue-html5plus-template</code> <code>https://github.com/vue-html5plus/vue-html5plus/wiki</code></p> <p>但测试在 vue 项目中加入<code>vue-html5plus</code> 然后按它的 example 目录下代码, 通过 hbuilder 打包后在真机没有获取到城市信息</p> <p><code>npm install vue-html5plus</code></p> <p>// main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> VueHtml5Plus <span class="token keyword">from</span> <span class="token string">'vue-html5plus'</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueHtml5Plus<span class="token punctuation">)</span>
</code></pre></div><p>// App.vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>当前定位城市：<span class="token punctuation">{</span><span class="token punctuation">{</span>city<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>
  <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      city<span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">plusReady</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>os<span class="token punctuation">.</span>plus<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'plusReady'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$geolocation<span class="token punctuation">.</span><span class="token function">getCurrentPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> position<span class="token punctuation">.</span>address<span class="token punctuation">.</span>city
      <span class="token keyword">this</span><span class="token punctuation">.</span>$nativeUI<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>但通过 hbuilder 打包后在真机没有获取到城市信息</p> <p>于是尝试另外的<code>vue-html5plus-template</code>建立项目</p> <p><code>vue init vue-html5plus/vue-html5plus-template</code></p> <p>虽然这个可以跑通但是和我们一般的 vue 目录结构相差很远</p> <p>其他尝试 vue 项目引入 h5plus
<code>https://github.com/newsning/vue-h5plus</code> <code>https://juejin.im/post/5a5702776fb9a01cb256d907</code> <code>http://ask.dcloud.net.cn/article/1134</code> <code>https://github.com/tyaqing/mogo-h5plus</code> 看文档</p> <p><code>https://www.jianshu.com/p/4ebf91053851</code> <code>http://ask.dcloud.net.cn/question/52740</code></p> <p><code>https://blog.csdn.net/qq_27626333/article/details/51823311</code></p> <p><code>https://juejin.im/entry/594769f2ac502e006ba80474</code></p> <h2 id="html5plus"><a href="#html5plus" aria-hidden="true" class="header-anchor">#</a> html5plus</h2> <p>hbuilder 或者说 dcloud 它的主要产品是两个一个是 mui, 另外一个就是 html5plus</p> <p>html5plus 对应在代码上, 它实际就是很多的 js 对象, 这些 js 对象本质上是对移动端比如手机 sdk 的底层操作</p> <p>比如在安卓系统上实现的功能类, 可以操作摄像头, 读取地理位置等等, 然后把这样的功能类暴露出来给 js 使用</p> <p>于是这些可以操作手机 native 功能类的对象就是<code>html5plus</code></p> <p>那么具体的怎么使用这些 html5plus 呢?</p> <ol><li><p>只要是使用 hbuilder 打包的 APP 项目都是可以使用 dcloud 开发的这个运行环境, 也就可以使用 html5plus
所以项目必须是用 hbuilder 打包且为移动 APP 项目</p></li> <li><p>加载<code>html5plus</code>, 我们通常意义上所说的加载 js 都是加载本地 js, 或者加载 cdn 路径的具体 js 代码
而 html5plus 实际上是个环境, 所以它的加载是自动加载, 我们需要只是什么时候加载成功了
只有这个运行环境加载成功后我们才能使用这些具有<code>native</code>功能的<code>js对象</code></p> <p>如果是 mui 那就是这样的 <code>mui.plusready(function(){})</code></p> <p>我们需要执行的 native 功能 js 对象的代码都必须写在 plusready 的回调里面</p> <p>而我们如果只是需要单独使用 html5plus 那么 <code>&lt;script src=&quot;html5plus://ready&quot;&gt;&lt;/script&gt;</code></p> <p>把这个 script 写在页面 header 里, 那么这样在<code>header</code>引入就是为了这脚本需要在浏览器渲染页面之前就执行的</p> <p>在这个脚本加载成功后, 我们就可以使用 plus 对象, 那么为了确定当前 plus 对象可用, 官方的示例代码,一般是这样的</p> <p>如果 plus 已经加载成功, 那么我们就直接执行需要执行的方法</p> <p>否则设置<code>plusready</code>回调, 等待当 plus 加载成功, 再执行需要执行的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ws <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前Webview窗口：'</span> <span class="token operator">+</span> ws<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>plus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'plusready'</span><span class="token punctuation">,</span> plusReady<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>plus 对象 <code>https://www.html5plus.org/doc/zh_cn</code></p> <p>通过文档可见所有的这些<code>js native 对象</code>可以对各种设备进行操作, 且他们都是属于 plus 的属性对象</p> <p>比如手机的按键 那么就是 plus.key 对象</p> <p>当前的页面窗口对象 plus.webview.currentWebview();</p> <p>// 对后退按钮的监听, 当点击后退就关闭当前页面</p> <div class="language-js extra-class"><pre class="language-js"><code>plus<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'backbutton'</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ws <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>vue 中使用 plus 对象</p> <p>因为 vue 一般用来做单页面应用, 于是只要 index.html 中加载了<code>html5plus</code></p> <p>那么在组件中就可以直接使用 plus 对象了, 比如调用系统分享</p> <p><code>https://www.html5plus.org/doc/zh_cn/share.html#plus.share.sendWithSystem</code></p> <p>我们直接在需要分享的 vue 组件里面使用 plus 对象来调用 html5plus 提供的 native 原生的分享功能
调用的是系统分享这个是最简单的, 如果要调用分享服务就要稍微复杂点</p> <div class="language-js extra-class"><pre class="language-js"><code>plus<span class="token punctuation">.</span>share<span class="token punctuation">.</span><span class="token function">sendWithSystem</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> content<span class="token punctuation">:</span> <span class="token string">'分享内容'</span><span class="token punctuation">,</span> href<span class="token punctuation">:</span> <span class="token string">'http://www.dcloud.io/'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'分享成功'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'分享失败：'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>调试</p></li></ol> <p>调试 html5plus 这个是比较麻烦的, 因为必须在它的真机运行环境才能测试, 所以凡是涉及到 plus 对象的代码,
每次只能对 vue 项目进行 build 后放到 hbuilder 里面调用真机调试</p> <p>在 vue 中使用 plus 应该还有其他问题 后面再继续探索</p> <h2 id="二维码"><a href="#二维码" aria-hidden="true" class="header-anchor">#</a> 二维码</h2> <p>生成带参数的二维码 , 这个二维码就是公众号的二维码, 如果没有关注的话, 扫码后就是提示关注公众号</p> <p><code>https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1443433542</code></p> <p>两个步骤</p> <ol><li><p>获取 ticket , 访问微信创建二维码 ticket 的 API 地址, 按要求提供 access_token 和 POST 数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">URL</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>cgi<span class="token operator">-</span>bin<span class="token operator">/</span>qrcode<span class="token operator">/</span>create<span class="token operator">?</span>access_token<span class="token operator">=</span><span class="token constant">TOKEN</span>
<span class="token constant">POST</span>数据格式：json
<span class="token constant">POST</span>数据例子：<span class="token punctuation">{</span><span class="token string">&quot;expire_seconds&quot;</span><span class="token punctuation">:</span> <span class="token number">604800</span><span class="token punctuation">,</span> <span class="token string">&quot;action_name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;QR_SCENE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;action_info&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;scene&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;scene_id&quot;</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div><p>// 正确的 Json 返回结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">:</span>&quot;gQH47joAAAAAAAAAASxodHRwOi8vd2VpeGluLnFxLmNvbS9xL2taZ2Z3TVRtNzJXV1Brb3ZhYmJJAAIEZ23sUwMEmm
<span class="token number">3</span>sUw<span class="token operator">==</span><span class="token string">&quot;,&quot;</span>expire_seconds<span class="token string">&quot;:60,&quot;</span>url<span class="token string">&quot;:&quot;</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>q<span class="token operator">/</span>kZgfwMTm72WWPkovabbI&quot;<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>通过 ticket 换取二维码</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">HTTP</span> <span class="token constant">GET</span>请求（请使用https协议）https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mp<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>cgi<span class="token operator">-</span>bin<span class="token operator">/</span>showqrcode<span class="token operator">?</span>ticket<span class="token operator">=</span><span class="token constant">TICKET</span>
提醒：<span class="token constant">TICKET</span>记得进行UrlEncode
</code></pre></div><p>ticket 正确情况下，http 返回码是 200，是一张图片，可以直接展示或者下载。</p> <p>我们也可以自己进行二维码的生成</p> <p>经过上面两步就能得到微信给我们提供的带参数的二维码 , 它本质上是一个 url , 相当于是经过微信认证过的 url, 所以我们也可以在获取到 ticket url 后自己来生成 url</p> <p>那么这个二维码是有时限和参数的, 所以, 我们也需要把二维码放到数据库中, 因此我们除了访问接口获取 url 外还需要做两件事</p> <ol><li><p>二维码存储到数据库, 因为它和场景参数还有时限等有关</p></li> <li><p>自己写一个可生成二维码的方法 , 虽然微信有接口可用用来生成二维码, 但自己还是应该准备一个</p></li></ol> <p>后续 : 当二维码被扫后, 微信会发送消息给我们后台, 通知我们有人扫码, 我们可以把消息也保存到数据库进行统计</p> <p>一般可以统计扫码数和扫码注册数</p> <h2 id="微信二维码-demo"><a href="#微信二维码-demo" aria-hidden="true" class="header-anchor">#</a> 微信二维码 demo</h2> <p>这个二维码是公众号的二维码</p> <p>以 vivitek_solution 开发中用的测试公众号为 demo</p> <p>这个二维码的生成是后台和微信公众服务器的交互后产生, 因此, 它是后台提供服务代码</p> <p>当我们后台和腾讯服务器交互后拿到了返回的 url , 根据这个 url 生成二维码就是公众号二维码</p> <p>生成 qrcode ticket 测试地址 <code>http://vivitek.qtrouter.com/weixin/qrcode_test_ticket</code></p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/qrcode_test_ticket'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getQRCodeTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 获取公众号二维码api请求需要的ticket</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getQRCodeTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 按公众号文档来访问api获取qrcode ticket</span>
  <span class="token comment">// 获取tocken</span>
  <span class="token keyword">let</span> access_token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 按文档需要post的数据, 创建临时二维码</span>
  <span class="token comment">// 默认创建永久二维码</span>
  <span class="token keyword">let</span> param <span class="token operator">=</span> <span class="token punctuation">{</span>
    action_name<span class="token punctuation">:</span> <span class="token string">'QR_LIMIT_SCENE'</span><span class="token punctuation">,</span>
    action_info<span class="token punctuation">:</span> <span class="token punctuation">{</span> scene<span class="token punctuation">:</span> <span class="token punctuation">{</span> scene_str<span class="token punctuation">:</span> config<span class="token punctuation">.</span>qrcode_scene_str <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 临时二维码参数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>qrcode_temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    param <span class="token operator">=</span> <span class="token punctuation">{</span>
      expire_seconds<span class="token punctuation">:</span> <span class="token number">604800</span><span class="token punctuation">,</span> <span class="token comment">// 30天</span>
      action_name<span class="token punctuation">:</span> <span class="token string">'QR_STR_SCENE'</span><span class="token punctuation">,</span> <span class="token comment">// QR_STR_SCENE为临时的字符串参数值</span>
      action_info<span class="token punctuation">:</span> <span class="token punctuation">{</span> scene<span class="token punctuation">:</span> <span class="token punctuation">{</span> scene_str<span class="token punctuation">:</span> config<span class="token punctuation">.</span>qrcode_scene_str <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 提交数据</span>
  <span class="token keyword">let</span> api_url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>api_url<span class="token punctuation">,</span> param<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>// qr ticket 一起返回的 url , 实际上这个 url 就是公众号的扫码地址</p> <p>但这个地址不能直接访问, 必须先生成二维码, 然后通过微信的扫一扫来访问, 比如用<code>http://cli.im/</code> 这个站点来生成二维码</p> <p>当扫码后, 以前未关注这个公众号的话, 就会出现关注页面 ,</p> <p>已经关注过的话, 那么就会打开公众号首页 . 我们可以取消关注, 然后重新关注来做测试</p> <p>那么生成二维码, 我们可以用自己的服务来生成, 也可以用腾讯提供的接口来生成</p> <p>用腾讯接口是最方便的, 因为获取到 tiket 然后就能直接得到二维码地址, 比如访问下面地址直接就是我们的公众号二维码</p> <p><code>https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=gQGV8DwAAAAAAAAAAS5odHRwOi8vd2VpeGluLnFxLmNvbS9xLzAydWYyU1JQZXBlcGwxMDAwMHcwMzEAAgTVJylbAwQAAAAA</code></p> <p>等于使用 ticket 返回 url, 比如用<code>http://cli.im/</code> 这个站点来生成的二维码</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get-qrcode-url'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> qrcode_response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getQRCodeTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// console.log(qrcode_response.data)</span>
  <span class="token keyword">let</span> qr_ticket <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>qrcode_response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket<span class="token punctuation">)</span>
  <span class="token keyword">let</span> output_qrcode_api <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qr_ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output_qrcode_api<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>output_qrcode_api<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>那么我们只要提供<code>get-qrcode-url</code> 即可, 移动端可以访问这个接口地址来获取二维码地址就可以了</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f8bee57c.js" defer></script><script src="/assets/js/11.bbd08110.js" defer></script>
  </body>
</html>
